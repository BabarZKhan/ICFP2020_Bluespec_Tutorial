<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="description" content="Bluespec Tutorial">
<meta name="keywords" content="Bluespec, BH, BSV, Bluespec Classic, HLHDL, High-Level Hardware Design, RISC-V">
<meta name="author" content="Rishiyur S. Nikhil, Bluespec, Inc. (c) 2020">
<title>Designing Hardware Systems and Accelerators with Open-Source BH (Bluespec Haskell)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Designing Hardware Systems and Accelerators with Open-Source BH (Bluespec Haskell)</h1>
<div class="details">
<span id="author" class="author">Rishiyur S. Nikhil, Bluespec, Inc. (c) 2020</span><br>
<span id="revnumber">version v0.1,</span>
<span id="revdate">2020-08-10</span>
<br><span id="revremark">First draft</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#_abstract">1. ABSTRACT</a></li>
<li><a href="#_please_install_the_following">2. Please install the following.</a></li>
<li><a href="#_introduction">3. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_why_should_one_design_and_create_hardware">3.1. Why Should One Design and Create Hardware?</a></li>
<li><a href="#_why_em_shouldn_t_em_one_design_and_create_hardware">3.2. Why <em>Shouldn&#8217;t</em> One Design and Create Hardware?</a></li>
<li><a href="#_the_flows_processes_for_developing_hardware">3.3. The flows/processes for developing hardware</a></li>
<li><a href="#_what_is_an_fpga">3.4. What is an FPGA?</a></li>
<li><a href="#_how_where_can_i_get_an_fpga_and_fpga_asic_tools">3.5. How/Where can I get an FPGA and FPGA/ASIC tools?</a></li>
<li><a href="#_plan_for_this_tutorial">3.6. Plan for this tutorial</a></li>
<li><a href="#_a_note_on_the_em_bsc_em_tool_and_bluespec_bh_and_bsv_code_syntax">3.7. A note on the <em>bsc</em> tool and Bluespec BH and BSV code syntax</a></li>
</ul>
</li>
<li><a href="#_limbering_up_hello_world">4. Limbering up: &#8220;Hello World!&#8221;</a>
<ul class="sectlevel2">
<li><a href="#_the_code">4.1. The code</a>
<ul class="sectlevel3">
<li><a href="#_structure_executing_a_bh_bsv_program_describes_a_piece_of_hardware">4.1.1. STRUCTURE: executing a BH/BSV program describes a piece of hardware</a></li>
<li><a href="#_behavior_executing_the_hardware">4.1.2. BEHAVIOR: executing the hardware</a></li>
<li><a href="#_let_s_do_it_bluesim_compile_link_and_simulate">4.1.3. Let&#8217;s do it! Bluesim compile, link and simulate</a></li>
<li><a href="#_a_fanciful_visualization_of_verilog_hardware_described_by_the_code">4.1.4. A (fanciful) visualization of Verilog hardware described by the code</a></li>
<li><a href="#_let_s_do_it_verilog_compile_link_and_simulate">4.1.5. Let&#8217;s do it! Verilog compile, link and simulate</a></li>
</ul>
</li>
<li><a href="#_stepping_back_for_some_perspective_haskell_or_pls_in_general_vs_bh_bsv">4.2. Stepping back for some perspective: Haskell (or PLs in general) vs. BH/BSV</a></li>
<li><a href="#_hello_world_version_b_packages_and_modules">4.3. Hello World! Version (b): Packages and Modules</a>
<ul class="sectlevel3">
<li><a href="#_interfaces_and_interface_types">4.3.1. Interfaces and interface types</a></li>
<li><a href="#_synthesis_boundaries">4.3.2. Synthesis boundaries</a></li>
<li><a href="#_packages_imports_and_files">4.3.3. Packages, imports, and files</a></li>
<li><a href="#_separate_compilation">4.3.4. Separate compilation</a></li>
<li><a href="#_instantiating_modules_and_invoking_their_methods">4.3.5. Instantiating modules and invoking their methods</a></li>
<li><a href="#_let_s_do_it_compile_link_and_simulate_the_example">4.3.6. Let&#8217;s do it! Compile, link and simulate the example:</a></li>
</ul>
</li>
<li><a href="#_hello_world_version_c_state_and_time">4.4. Hello World! Version (c): State and Time</a>
<ul class="sectlevel3">
<li><a href="#_action_actionvalue_and_value_interface_methods">4.4.1. Action, ActionValue and Value interface methods</a></li>
<li><a href="#_algebraic_types">4.4.2. Algebraic types</a></li>
<li><a href="#_registers_instantiation_initializing_and_operations">4.4.3. Registers: Instantiation, initializing, and operations</a></li>
<li><a href="#_local_values_bit_selection_and_combinational_circuits">4.4.4. Local values, bit selection and combinational circuits</a></li>
<li><a href="#_interface_method_conditions_and_actions">4.4.5. Interface method conditions and actions</a></li>
<li><a href="#_rule_conditions">4.4.6. Rule conditions</a></li>
<li><a href="#_let_s_do_it_compile_link_and_simulate_the_example_2">4.4.7. Let&#8217;s do it! Compile, link and simulate the example:</a></li>
<li><a href="#_visualizing_the_hardware_for_code_mktop_code_rule_level_view">4.4.8. Visualizing the hardware for <code>mkTop</code>: rule-level view</a></li>
<li><a href="#_visualizing_the_hardware_for_code_mktop_code_verilog_rtl_view">4.4.9. Visualizing the hardware for <code>mkTop</code>: Verilog RTL view</a></li>
<li><a href="#_visualizing_the_hardware_for_code_mkdeepthought_code_rule_level_view">4.4.10. Visualizing the hardware for <code>mkDeepThought</code>: rule-level view</a></li>
<li><a href="#_visualizing_the_hardware_for_code_mkdeepthought_code_verilog_rtl_view">4.4.11. Visualizing the hardware for <code>mkDeepThought</code>: Verilog RTL view</a></li>
<li><a href="#_waveforms_vcd_files_and_waveform_viewers">4.4.12. Waveforms: VCD files and Waveform viewers</a></li>
</ul>
</li>
<li><a href="#_simulation_and_synthesis_semantics_are_the_same_in_bh_bsv">4.5. Simulation and Synthesis semantics are the same in BH/BSV</a></li>
<li><a href="#HDLS_vs_HLS">4.6. HLHDLs vs. HLS: precise specification of micro-architecture</a></li>
<li><a href="#_numeric_types_and_kinds_in_bh_bsv">4.7. Numeric types and kinds in BH/BSV</a></li>
</ul>
</li>
<li><a href="#_introducing_concurrency_with_bubblesort_as_example">5. Introducing Concurrency with Bubblesort as Example</a>
<ul class="sectlevel2">
<li><a href="#_bubblesort_version_a_sequential_a_finite_state_machine">5.1. Bubblesort Version (a): Sequential (a finite state machine)</a>
<ul class="sectlevel3">
<li><a href="#__code_mkbubblesort_code_interface">5.1.1. <code>mkBubblesort</code>: interface</a></li>
<li><a href="#__code_mkbubblesort_code_state_elements">5.1.2. <code>mkBubblesort</code>: state elements</a></li>
<li><a href="#__code_mkbubblesort_code_input">5.1.3. <code>mkBubblesort</code>: input</a></li>
<li><a href="#__code_mkbubblesort_code_sorting">5.1.4. <code>mkBubblesort</code>: sorting</a></li>
<li><a href="#__code_mkbubblesort_code_termination">5.1.5. <code>mkBubblesort</code>: termination</a></li>
<li><a href="#__code_mkbubblesort_code_output">5.1.6. <code>mkBubblesort</code>: output</a></li>
<li><a href="#__code_mktop_code_the_driver_testbench_in_file_code_top_bs_code">5.1.7. <code>mkTop</code>, the driver &#8220;testbench&#8221; (in file <code>Top.bs</code>)</a></li>
<li><a href="#_let_s_do_it_compile_link_and_simulate_the_example_3">5.1.8. Let&#8217;s do it! Compile, link and simulate the example</a></li>
<li><a href="#_waveforms_code_gtkwave_dump_vcd_code">5.1.9. Waveforms (<code>$ gtkwave  dump.vcd</code>)</a></li>
</ul>
</li>
<li><a href="#_bubblesort_version_b_with_concurrency">5.2. Bubblesort Version (b): with concurrency</a>
<ul class="sectlevel3">
<li><a href="#_bubblesort_with_concurrency">5.2.1. Bubblesort with concurrency</a></li>
<li><a href="#_swapping">5.2.2. Swapping</a></li>
<li><a href="#_swapping_and_concurrency">5.2.3. Swapping and concurrency</a></li>
<li><a href="#_input">5.2.4. Input</a></li>
<li><a href="#_output">5.2.5. Output</a></li>
<li><a href="#_let_s_do_it_compile_link_and_simulate_the_example_and_look_at_waves">5.2.6. Let&#8217;s do it! Compile, link and simulate the example, and look at waves</a></li>
</ul>
</li>
<li><a href="#_bubblesort_versions_c_d_and_e_generalizations">5.3. Bubblesort Versions (c), (d) and (e): generalizations</a>
<ul class="sectlevel3">
<li><a href="#_bubblesort_version_e_highlights">5.3.1. Bubblesort Version (e): highlights</a></li>
</ul>
</li>
<li><a href="#_an_aside_on_style">5.4. An Aside on Style</a></li>
</ul>
</li>
<li><a href="#_pipelining_memory_access_and_accelerators_example_mergesort">6. Pipelining, memory access and accelerators (example: &#8220;Mergesort&#8221;)</a>
<ul class="sectlevel2">
<li><a href="#_where_do_accelerators_fit_into_a_computer_system">6.1. Where do Accelerators Fit into a Computer System?</a></li>
<li><a href="#_our_example_a_memory_to_memory_mergesort_accelerator">6.2. Our example: a memory-to-memory &#8220;mergesort&#8221; accelerator</a></li>
<li><a href="#_mergesort_source_codes">6.3. Mergesort: source codes</a></li>
<li><a href="#_mergesort_algorithm">6.4. Mergesort algorithm</a></li>
<li><a href="#_mergesort_visualizing_the_merge_step">6.5. Mergesort: visualizing the merge step</a></li>
<li><a href="#_the_merge_engine_sorts_two_input_segments_into_1_output_segment">6.6. The Merge Engine (sorts two input segments into 1 output segment)</a></li>
<li><a href="#_the_merge_engine_interface">6.7. The Merge Engine: interface</a></li>
<li><a href="#_the_merge_engine_talking_to_the_axi4_interconnect_bus">6.8. The Merge Engine: Talking to the AXI4 interconnect (bus)</a></li>
<li><a href="#_the_merge_engine_flow">6.9. The Merge Engine: Flow</a></li>
<li><a href="#_the_merge_engine_avoiding_deadlock_in_the_pipeline">6.10. The Merge Engine: Avoiding Deadlock in the Pipeline</a></li>
<li><a href="#_the_mergesort_module_code_mkaxi4_accel_code_in_file_code_axi4_accel_bs_code">6.11. The Mergesort Module (<code>mkAXI4_Accel</code> in file <code>AXI4_Accel.bs</code>)</a></li>
<li><a href="#_the_mergesort_module_code_code_mkaxi4_accel_code_in_file_code_axi4_accel_bs_code">6.12. The Mergesort Module Code (<code>mkAXI4_Accel</code> in file <code>AXI4_Accel.bs</code>)</a></li>
<li><a href="#_let_s_do_it_compile_link_the_example_but_don_t_try_simulating_yet">6.13. Let&#8217;s do it! Compile, link the example (but don&#8217;t try simulating yet)</a></li>
<li><a href="#_for_simulation_risc_v_machine_code_for_flute_execution">6.14. For simulation: RISC-V machine-code for Flute execution</a></li>
<li><a href="#_let_s_do_it_run_the_hello_world_risc_v_binary">6.15. Let&#8217;s do it! Run the &#8220;Hello, World!&#8221; RISC-V binary.</a></li>
<li><a href="#_c_code_to_test_the_mergesort_accelerator">6.16. C code to test the mergesort accelerator</a></li>
<li><a href="#_let_s_do_it_run_the_code_mergesort_code_risc_v_binary">6.17. Let&#8217;s do it! Run the <code>mergesort</code> RISC-V binary.</a></li>
<li><a href="#_mergesort_possible_improvements_suggested_exercise">6.18. Mergesort: Possible Improvements (suggested exercise!)</a></li>
</ul>
</li>
<li><a href="#_clocks_concurrency_semantics_performance_and_concurrent_registers">7. Clocks, Concurrency Semantics, Performance, and Concurrent Registers</a>
<ul class="sectlevel2">
<li><a href="#_concurrency_and_parallelism_in_em_bsc_em_generated_hardware_for_rules">7.1. Concurrency and Parallelism in <em>bsc</em>-generated Hardware for Rules</a></li>
<li><a href="#_parallelism_simultaneity_of_actions_in_a_rule">7.2. Parallelism (Simultaneity) of Actions in a Rule</a></li>
<li><a href="#_concurrency_of_rules_within_a_clock">7.3. Concurrency of Rules Within a Clock</a></li>
<li><a href="#_method_ordering_constraints_inducing_conflicts">7.4. Method-ordering Constraints (Inducing &#8220;Conflicts&#8221;)</a></li>
<li><a href="#_example_of_method_ordering_constraints_on_primitive_registers">7.5. Example of Method-ordering Constraints on Primitive Registers</a></li>
<li><a href="#_from_method_ordering_to_rule_conflicts">7.6. From Method Ordering to Rule Conflicts</a></li>
<li><a href="#_for_conflicts_the_earlier_rule_disables_the_later_rule">7.7. For Conflicts, the Earlier Rule Disables the Later Rule</a></li>
<li><a href="#_summary_of_rule_semantics">7.8. Summary of Rule Semantics</a></li>
<li><a href="#_concurrent_registers_cregs_motivation">7.9. Concurrent Registers (CRegs): Motivation</a></li>
<li><a href="#_concurrent_registers_cregs">7.10. Concurrent Registers (CRegs)</a></li>
<li><a href="#_concurrent_registers_cregs_hardware_implemntation">7.11. Concurrent Registers (CRegs): Hardware Implemntation</a></li>
</ul>
</li>
<li><a href="#_a_word_about_multiple_clocks_and_resets_and_clock_domains_and_reset_domains">8. A Word About Multiple Clocks (and Resets) and Clock Domains (and Reset Domains)</a></li>
<li><a href="#_quality_metrics_for_hardware">9. Quality metrics for hardware</a>
<ul class="sectlevel2">
<li><a href="#_formal_verification">9.1. Formal Verification</a></li>
</ul>
</li>
<li><a href="#_endnote_comparison_with_other_approaches_to_hardware_design">10. Endnote: Comparison with other approaches to hardware-design</a></li>
<li><a href="#_bibliography">11. Bibliography</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Tutorial at ICFP 2020 (25th ACM SIGPLAN International Conference on Functional Programming)</p>
</div>
<div class="paragraph">
<p>Online, August 23, 2020, 14:00h-17:00h EDT</p>
</div>
<hr>
<div class="paragraph">
<p>Tutorial materials at: <a href="https://github.com/rsnikhil/ICFP2020_Bluespec_Tutorial" class="bare">https://github.com/rsnikhil/ICFP2020_Bluespec_Tutorial</a></p>
</div>
<div class="paragraph">
<p><strong>Viewing this document</strong></p>
</div>
<div class="paragraph">
<p>The source for this document is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    ICFP2020_Bluespec_Tutorial.adoc</pre>
</div>
</div>
<div class="paragraph">
<p>and there is also an HTML version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    ICFP2020_Bluespec_Tutorial_BH.html</pre>
</div>
</div>
<div class="paragraph">
<p>The latter is produced from the former using <code>asciidoctor</code>, which is
available in most package installers (e.g., <code>apt-get install asciidoctor</code>).</p>
</div>
<div class="paragraph">
<p>GitHub and some browsers with <code>asciidoc</code> plug-ins will automatically
process and display the <code>.adoc</code> version.  Otherwise, please have your
browser display the <code>.html</code> version.</p>
</div>
<hr>
</div>
</div>
<div class="sect1 center">
<h2 id="_abstract">1. ABSTRACT</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Have you ever considered designing and implementing a piece of digital
hardware, such as an accelerator on an attached FPGA for a complex
computation (Machine Learning, Computer Vision, &#8230;&#8203;), or just for fun,
but were afraid that hardware design was too far from your wheelhouse?</p>
</div>
<div class="paragraph">
<p>In this tutorial we hope to leverage your knowledge of Haskell to
demystify this, using a lecture + demonstration format which you can
follow along on your laptop during the tutorial.  We will use Bluespec
BH, which is a high-level hardware design language using Haskell
syntax and types.  BH and its sibling BSV are mature,
industrial-strength hardware design languages, with over 20 years of
development; they have been used to design complex components in
commercial shipping chips.  The <code>bsc</code> tool for compiling BH and BSV to
Verilog was open-sourced in January 2020.</p>
</div>
<div class="paragraph">
<p>For background preparation we only assume you know Haskell, and
perhaps nothing about hardware design.</p>
</div>
<div class="paragraph">
<p>We will start with a simple &#8220;Hello World!&#8221; example, but rapidly climb
through the gears to end with a complete, Linux-capable RISC-V CPU
controlling a pipelined memory-to-memory array-sorting accelerator
(all the materials for this are open-source).</p>
</div>
<div class="paragraph">
<p>At the end of the tutorial, we hope you will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand how a Haskell-based language (Haskell syntax, Haskell
types) can be used to describe complex hardware system <strong>STRUCTURE</strong>,
and how <em>Guarded Atomic Actions</em> (rewrite rules) can be used to
describe complex hardware system <strong>BEHAVIOR</strong> in a composable way (and
also enabling formal verification).</p>
</li>
<li>
<p>Feel: &#8220;I can do this!&#8221;, i.e., that you can read and modify the
open-source designs shown in the tutorial, or even create your own
hardware designs.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_please_install_the_following">2. Please install the following.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To study the code and run all the examples in this tutorial, please
install the following (everything here is free and open-source):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>bsc</code> compiler from <a href="https://github.com/B-Lang-org/bsc" class="bare">https://github.com/B-Lang-org/bsc</a>.</p>
</li>
<li>
<p>The open-source Verilog simulator <code>verilator</code> from
<a href="https://www.veripool.org" class="bare">https://www.veripool.org</a><br></p>
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can install the open-source Verilog
simulator <code>iverilog</code>, available standardly in common package
installers.  IVerilog is much slower; it is fine for small
examples, but simulation of large designs is not so pleasant.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The open-source waveform viewer <code>gtkwave</code> (available standardly in
common package installers)</p>
</li>
<li>
<p>Materials for this tutorial, from <a href="https://github.com/rsnikhil/ICFP2020_Bluespec_Tutorial" class="bare">https://github.com/rsnikhil/ICFP2020_Bluespec_Tutorial</a>.</p>
</li>
<li>
<p>The Bluespec <em>Flute</em> open-source RISC-V CPU, from <a href="https://github.com/bluespec/Flute" class="bare">https://github.com/bluespec/Flute</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ubuntu and Debian Linux are the preferred platforms, but people also use MacOS.</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">3. Introduction</h2>
<div class="sectionbody">
<hr>
<div class="sect2">
<h3 id="_why_should_one_design_and_create_hardware">3.1. Why Should One Design and Create Hardware?</h3>
<div class="paragraph">
<p>Any computation can be coded in a programming language and executed on
a general-purpose computing platform (from small single-chip embedded
computers to rack-mounted servers).  Much of the world&#8217;s hardware
design activity is perhaps indeed about general-purpose computing
platforms.</p>
</div>
<div class="paragraph">
<p>But any computation can also be implemented directly in hardware,
typically with <em>orders of magnitude</em> (often several) advantage in
speed and energy efficiency.  Why?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Removal of one or more layers of interpretation (starting with the
fetch-execute loop of a general-purpose CPU, and possibly more
layers above that)</p>
</li>
<li>
<p>Exploit massive, fine-grain (temporal and spatial) parallelism</p>
</li>
<li>
<p>Exploit massive memory bandwidth due to multiple, distributed, custom memories</p>
</li>
</ul>
</div>
<hr>
<div class="paragraph">
<p><strong>Why Should One Design and Create Hardware?</strong> (Contd.)</p>
</div>
<div class="paragraph">
<p>You servers, laptops and mobile devices already exploit this.  Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Virtual memory address translation and protection</p>
</li>
<li>
<p>Floating point units</p>
</li>
<li>
<p>Graphics</p>
</li>
<li>
<p>Video encoders/decoders</p>
</li>
<li>
<p>Network protocol offload engines (TCP, UDP, &#8230;&#8203;)</p>
</li>
<li>
<p>Signal processing for wireless communcation, GPS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Each of these computations can of course be coded in software, but that would not meet speed and/or energy targets.</em></p>
</div>
<div class="paragraph">
<p>More recently, as it becomes increasingly difficult to maintain
Moore&#8217;s Law and Dennard Law scaling in silicon we are seeing more and
more &#8220;accelerators&#8221;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Neural nets, Computer Vision, Crypto, Radar/Lidar, &#8230;&#8203;</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_why_em_shouldn_t_em_one_design_and_create_hardware">3.2. Why <em>Shouldn&#8217;t</em> One Design and Create Hardware?</h3>
<div class="paragraph">
<p>It takes a lot of time and effort, and possibly expense; and they&#8217;re a lot less flexible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ASIC<sup>1</sup> designs take months-to-years to develop, with multi-person teams and millions of dollars.</p>
<div class="ulist">
<ul>
<li>
<p>Only high volume and frequent use justify this.</p>
</li>
</ul>
</div>
</li>
<li>
<p>FPGA<sup>1</sup> designs can take hours-to-months to develop.</p>
<div class="ulist">
<ul>
<li>
<p>(Mostly because their tools are not as highly developed as software compilers and debuggers.)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hardware designs are typically single-purpose; they&#8217;re wasted if not in (frequent) use!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><sup>1</sup> <em>We&#8217;ll demystify &#8220;ASIC&#8221; and &#8220;FPGA&#8221; shortly.</em></p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_flows_processes_for_developing_hardware">3.3. The flows/processes for developing hardware</h3>
<div id="Fig_HW_Dev_Flows" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/HW_Dev_Flows.png" alt="HW Dev Flows">
</div>
<div class="title">Figure 1. In this tutorial, we will focus on BH &#8594; Simulator, and also describe &#8594; FPGA</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_what_is_an_fpga">3.4. What is an FPGA?</h3>
<div id="Fig_FPGA_Model" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/FPGA_Model.png" alt="FPGA Model" width="400">
</div>
<div class="title">Figure 2. Simplified model of an FPGA</div>
</div>
<div class="paragraph">
<p>Imagine an FPGA as a pre-built set of components laid out like &#8220;Manhattan city blocks&#8221;.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each block has a collection of AND gates, OR gates, multiplexers (&#8220;muxes&#8221;), &#8230;&#8203;<sup>1</sup></p>
</li>
<li>
<p>The &#8220;streets&#8221; and &#8220;avenues&#8221; are laid out with wires (&#8220;utility cables and pipes&#8221;)</p>
</li>
<li>
<p>By making certain connections (red dots in figure), we can connect
an output from one city block to an input in another city block.</p>
</li>
<li>
<p>By choosing these connections, we can make the FPGA look like any circuit we want</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FPGA tools produce a &#8220;bitfile&#8221;; each bit is a red dot, i.e., it
controls whether connection is made or not.<br></p>
</div>
<div class="paragraph">
<p><sup>1</sup><strong><em>But don&#8217;t worry: we are not going to descend to this ``machine language'' level;
bitfiles are produced for us by FPGA tools (compilers)!</em></strong></p>
</div>
<div class="paragraph">
<p><sup>2</sup><em>More generally, rather than gates, FPGAs provide &#8220;LUTs&#8221;
(Lookup-Tables) which can themselves be programmed to act like
specific gates or combinational circuits. Other resources include
registers, SRAMs (memories), DSPs (digital signal processors), and
more.</em></p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_how_where_can_i_get_an_fpga_and_fpga_asic_tools">3.5. How/Where can I get an FPGA and FPGA/ASIC tools?</h3>
<div class="ulist">
<ul>
<li>
<p>You can buy off-the-shelf &#8220;development boards&#8221; from FPGA vendors,
which are complete circuit boards containing an FPGA and lots of
surrounding circuitry (DRAM, connectivity such as USB cables, PCIe
connectors, Ethernet, &#8230;&#8203;)</p>
<div class="ulist">
<ul>
<li>
<p>Boards range from a few tens of dollars to thousands of
dollars, depending on capacity of the FPGA, speed of the FPGA,
resources on the FPGA, resources on the board, etc.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Nowadays cloud-computing providers (e.g., Amazon AWS, Google) allow
you to select &#8220;FPGA instances&#8221; in the cloud, so that you are
connected to servers that have attached FPGA boards (typically
over PCIe connectors).</p>
</li>
<li>
<p>Sadly, FPGA and ASIC tools are still mostly vendor-proprietary</p>
<div class="ulist">
<ul>
<li>
<p>FPGA tools are often available for free for evaluation, and
with FPGA purchases, and free on cloud platforms.</p>
</li>
<li>
<p>ASIC tools and libraries are expensive, but can be free/cheap for academia.</p>
</li>
<li>
<p><a href="https://www.symbioticeda.com">Symbiotic EDA</a> is one company that
trying to change this (free and open-source tools)</p>
<div class="ulist">
<ul>
<li>
<p>They also do tools and service for <em>formal verification</em> of hardware systems.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_plan_for_this_tutorial">3.6. Plan for this tutorial</h3>
<div class="ulist">
<ul>
<li>
<p>We will start with a simple "Hello World!" example.  Like all
Hello-World examples, the purpose is actually to familiarize you
with the &#8220;look and feel&#8221; of the language, tools and flow.</p>
</li>
<li>
<p>We&#8217;ll do a hardware concurrent &#8220;Bubblesort&#8221; example.  Bubblesort
is not a good sorting algorithm, but the purpose here is to
familiarize you with parallelism and concurrency in hardware.</p>
</li>
<li>
<p>We&#8217;ll do a hardware, concurrent, highly pipelined, memory-to-memory
&#8220;Mergesort&#8221; example.  Being memory-to-memory, it is capable of
sorting large arrays.  We&#8217;ll connect this as an &#8220;accelerator&#8221; in a
small, but complete, Linux-capable, RISC-V CPU-based, &#8220;SoC&#8221;
(System on a Chip).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>All the tools and materials in this tutorial are free and open-source.</em></p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_a_note_on_the_em_bsc_em_tool_and_bluespec_bh_and_bsv_code_syntax">3.7. A note on the <em>bsc</em> tool and Bluespec BH and BSV code syntax</h3>
<div class="paragraph">
<p>The central tool we use is <em>bsc</em>, a compiler that converts our source
code into Verilog RTL.  It was released as a
<a href="https://github.com/B-Lang-org/bsc">free and open-source tool</a>
in January 2020..</p>
</div>
<div class="paragraph">
<p>The <em>bsc</em> compiler supports two equivalent and interchangeable
source-code syntaxes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BH</dt>
<dd>
<p>Bluespec Haskell, also known as Bluesepec Classic</p>
</dd>
<dt class="hdlist1">BSV</dt>
<dd>
<p>Bluespec SystemVerilog</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In this tutorial we use BH, since the ICFP audience is familiar with
Haskell.  All the code we show can also be done in BSV.</p>
</div>
<div class="paragraph">
<p>Some of the code we use (in particular the RISC-V CPU and components)
were written in BSV.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limbering_up_hello_world">4. Limbering up: &#8220;Hello World!&#8221;</h2>
<div class="sectionbody">
<hr>
<div class="sect2">
<h3 id="_the_code">4.1. The code</h3>
<div class="paragraph">
<p>Please visit this directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ cd Examples/Eg020a_HelloWorld</code></pre>
</div>
</div>
<div class="paragraph">
<p>And bring up the file <code>src/Top.bs</code> in an editor, preferably in a
separate editor window.  Here&#8217;s the source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mkTop :: Module Empty
mkTop =
  module
    rules
      "rl_print_answer": when True ==&gt; do
          $display "\n\n***** Deep Thought says: Hello, World! *****"
          $display "      And the answer is: %0d (or, in hex: 0x%0h)\n"  42  42
          $finish</code></pre>
</div>
</div>
<hr>
<div class="sect3">
<h4 id="_structure_executing_a_bh_bsv_program_describes_a_piece_of_hardware">4.1.1. STRUCTURE: executing a BH/BSV program describes a piece of hardware</h4>
<div id="Hello_World_A_0" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Hello_World_A_0.png" alt="Hello World A 0" width="600">
</div>
<div class="title">Figure 3. A visualization of the hardware for our Hello World example</div>
</div>
<div class="ulist">
<ul>
<li>
<p>We define a single top-level identifier <code>mkTop</code>, giving it a type
declaration (<code>Module Empty</code>) and a value binding.  A value of type
<code>Module t</code> is a generator of hardware objects (it can be
&#8220;instantiated&#8221; multiple times).</p>
</li>
<li>
<p>The keyword <code>module</code> introduces a monadic expression, similar to Haskell&#8217;s <code>do</code>.
The monad &#8220;collects&#8221; various things like sub-modules, rules and interfaces</p>
<div class="ulist">
<ul>
<li>
<p>In this case it contains a single <code>rules</code> expression.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The <code>rules</code> keyword introduces one or more <em>rules</em> (here, just one).</p>
<div class="ulist">
<ul>
<li>
<p>A rule has a <em>condition expression</em> (here, <code>True</code>), of type <code>Bool</code></p>
</li>
<li>
<p>A rule has an <code>Action</code> <em>body</em> (here, two <code>$display</code> actions and a <code>$finish</code> action)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_behavior_executing_the_hardware">4.1.2. BEHAVIOR: executing the hardware</h4>
<div class="ulist">
<ul>
<li>
<p>A <em>rule</em> is like an infinite process:</p>
<div class="ulist">
<ul>
<li>
<p>It can &#8220;execute&#8221; (or &#8220;fire&#8221;) whenever its <em>Bool</em> condition is true.<sup>1</sup></p>
</li>
<li>
<p>A rule body is a recursive composition of <em>Actions</em> (and the rule body itself has type <em>Action</em>).</p>
</li>
<li>
<p>When a rule fires, all its Actions are performed &#8220;simultaneously&#8221; and &#8220;instantaneously&#8221;
(there is no temporal ordering amongst the Actions in a rule).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example, as soon as we begin execution, the rule fires
(because its condition is True), and it performs the three primitive
Actions in its body, &#8220;simultaneously&#8221;.<sup>2</sup></p>
</div>
<div class="paragraph">
<p><sup>1</sup> This is a first approximation; qualifications to come later.</p>
</div>
<div class="paragraph">
<p><sup>2</sup> These primitive actions have intuitive interpretations when we run
a simulation: <code>$display</code> will output the argument string on the
terminal, and <code>$finish</code> will terminate the simulation.  What can they
mean in real hardware (we&#8217;ll have a fanciful interpretation in a later
section).</p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_let_s_do_it_bluesim_compile_link_and_simulate">4.1.3. Let&#8217;s do it! Bluesim compile, link and simulate</h4>
<div class="sect4">
<h5 id="_compile">Compile &#8230;&#8203;</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Eg020a_HelloWorld
$ make b_compile
mkdir  -p build_b_sim
Compiling for Bluesim ...
bsc -u -sim -simdir build_b_sim -bdir build_b_sim -info-dir build_b_sim -keep-fires  -aggressive-conditions  -no-warn-action-shadowing  -check-assert  -cpp +RTS -K128M -RTS  -show-range-conflict      -p src:../Resources:+ -g mkTop  src/Top.bs
checking package dependencies
compiling src/Top.bs
code generation for mkTop starts
Elaborated module file created: build_b_sim/mkTop.ba
All packages are up to date.
Compiling for Bluesim finished</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bsc</code> is the Bluespec compiler for BH and BSV.  Its command-line flags can be listed with <code>bsc -help</code>; they are described in detail in <a href="#UserGuide">[UserGuide]</a>.  Here,</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-sim</code>: compile for Bluesim (native-compiled simulation)</p>
</li>
<li>
<p><code>src/Top.bs</code>:   Top-level file (which, in general, may contain multiple modules)</p>
</li>
<li>
<p><code>-g</code>: Name of top-level module</p>
</li>
<li>
<p><code>-p</code>: Search path for source files. <code>+</code> is shorthand for standard <code>bsc</code> libraries.</p>
</li>
<li>
<p><code>-u</code>: Compile imported packages as necessary (this example has none)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On compiling, <code>bsc</code> produces various intermediate files with
extensions like <code>.bo</code>, <code>.ba</code>, <code>.sched</code>, &#8230;&#8203; which can be placed into
separate directories to avoid clutter.</p>
</div>
<hr>
</div>
<div class="sect4">
<h5 id="__link">&#8230;&#8203; link &#8230;&#8203;</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ make b_link
Linking for Bluesim ...
bsc -e mkTop -sim -o mkTop_b_sim -simdir build_b_sim -bdir build_b_sim -info-dir build_b_sim -keep-fires -p src:../Resources:+
Bluesim object created: build_b_sim/mkTop.{h,o}
Bluesim object created: build_b_sim/model_mkTop.{h,o}
Simulation shared library created: mkTop_b_sim.so
Simulation executable created: mkTop_b_sim
Linking for Bluesim finished</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here,</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-e</code>: name of top-level module to be linked (<code>bsc</code> will chase modules that it depends on)</p>
</li>
<li>
<p><code>-o</code>: name of executable produced</p>
</li>
<li>
<p><code>-sim</code>: link for Bluesim</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Produces <code>mkTop_b_sim.so</code>, a standard ELF shared object, and <code>mkTop_b_sim</code>, a short shell script that loads and runs it.</p>
</div>
<hr>
</div>
<div class="sect4">
<h5 id="__simulate">&#8230;&#8203; simulate &#8230;&#8203;</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ make b_sim
Bluesim simulation ...
./mkTop_b_sim


***** Deep Thought says: Hello, World! *****
      And the answer is: 42 (or, in hex: 0x2a)

Bluesim simulation finished</code></pre>
</div>
</div>
<hr>
</div>
</div>
<div class="sect3">
<h4 id="_a_fanciful_visualization_of_verilog_hardware_described_by_the_code">4.1.4. A (fanciful) visualization of Verilog hardware described by the code</h4>
<div id="Hello_World_A_1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Hello_World_A_1.png" alt="Hello World A 1" width="600">
</div>
<div class="title">Figure 4. A (fanciful) visualization of the Verilog ``hardware'' for our Hello World example</div>
</div>
<div class="paragraph">
<p>(<em>Relax, don&#8217;t worry, this Verilog detail is just to develop
intuition about what&#8217;s under the covers, we won&#8217;t be coding or
thinking at this level.</em>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clocked digital circuit modules usually have &#8220;reset&#8221; (<code>RST_N</code>) and
&#8220;clock&#8221; (<code>CLK</code>) input signals.  These are <em>digital</em> signals,
i.e., their analogue voltages sit at one of two fixed values,
variously called &#8220;low&#8221; and &#8220;high&#8221;, or &#8220;0&#8221; and &#8220;1&#8221;, or
&#8220;false&#8221; and &#8220;true&#8221;, or &#8220;unasserted&#8221; and &#8220;asserted&#8221;.</p>
<div class="ulist">
<ul>
<li>
<p>Reset signals are often inverted, i.e., asserted when low, hence
the name <code>RST_N</code> (for negative or negated).</p>
</li>
</ul>
</div>
</li>
<li>
<p>A clock oscillates between 0 and 1; the transitions are often called
&#8220;posedge&#8221; and &#8220;negedge&#8221;.</p>
</li>
<li>
<p>The reset signal is usually asserted only once, at the start of
execution, allowing all the circuits to enter into a known initial
state.  Subsequently, the circuit&#8217;s behavior is determined by the
actions at the clock edges.</p>
</li>
<li>
<p>All actions are conceptually performed <em>at</em> a clock edge.  Inputs to
an action are values on wires just before the clock edge.  The
action may change the state of various entities, which are visible
just after the clock edge.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For our example,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Imagine <code>$display</code> hardware modules with displays that that flash a
message when their <code>ENA</code> (<em>enable</em>) input signal is asserted.</p>
</li>
<li>
<p>Imagine a <code>$finish</code> hardware module that switches off the system
when its <code>ENA</code> (<em>enable</em>) input signal is asserted.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_let_s_do_it_verilog_compile_link_and_simulate">4.1.5. Let&#8217;s do it! Verilog compile, link and simulate</h4>
<div class="sect4">
<h5 id="_compile_generate_verilog">Compile (generate Verilog) &#8230;&#8203;</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ make v_compile
mkdir  -p build_v
mkdir  -p verilog_RTL
Compiling for Verilog ...
bsc -u -verilog -vdir verilog_RTL -bdir build_v -info-dir build_v -keep-fires  -aggressive-conditions  -no-warn-action-shadowing  -check-assert  -cpp +RTS -K128M -RTS  -show-range-conflict      -p src:../Resources:+ -g mkTop  src/Top.bs
checking package dependencies
compiling src/Top.bs
code generation for mkTop starts
Verilog file created: verilog_RTL/mkTop.v
All packages are up to date.
Compiling for Verilog finished</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-verilog</code> instructs <code>bsc</code> to generate Verilog, instead of compiling for Bluesim.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect4">
<h5 id="__link_verilog_into_an_executable">&#8230;&#8203; link (Verilog, into an executable) &#8230;&#8203;</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ make v_link
Linking for Verilog sim ...
bsc -e mkTop -verilog -o ./mkTop_v_sim -vdir verilog_RTL -bdir build_v -info-dir build_v -vsim iverilog  verilog_RTL/mkTop.v
Verilog binary file created: ./mkTop_v_sim
Linking for Verilog sim finished</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-vsim iverilog</code> instructs <code>bsc</code> to link for the IVerilog simulator.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect4">
<h5 id="__simulate_verilog">&#8230;&#8203; simulate (Verilog) &#8230;&#8203;</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ make v_sim
Verilog simulation...
./mkTop_v_sim


***** Deep Thought says: Hello, World! *****
      And the answer is: 42 (or, in hex: 0x2a)

Verilog simulation finished</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stepping_back_for_some_perspective_haskell_or_pls_in_general_vs_bh_bsv">4.2. Stepping back for some perspective: Haskell (or PLs in general) vs. BH/BSV</h3>
<div id="Haskell_vs_Bluespec" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Haskell_vs_Bluespec.png" alt="Haskell vs Bluespec">
</div>
<div class="title">Figure 5. Haskell vs. Bluespec BH/BSV</div>
</div>
<div class="paragraph">
<p>To become a proficient Haskell programmer, in particular to write
<em>efficient</em> programs, you have to understand its dynamic model (to
varions levels of abstraction).</p>
</div>
<div class="paragraph">
<p>Similarly, to become a proficient BH/BSV programmer, in particular to
produce <em>efficient</em> hardware, you have to understand its dynamic
model (to various levels of abstraction).</p>
</div>
<div class="paragraph">
<p>This difference in dynamic models is the biggest jump in reorienting
yourself into a designer of good hardware.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_hello_world_version_b_packages_and_modules">4.3. Hello World! Version (b): Packages and Modules</h3>
<div class="paragraph">
<p>Please visit this directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ cd Examples/Eg020b_HelloWorld</code></pre>
</div>
</div>
<div class="paragraph">
<p>And bring up the files <code>src/Top.bs</code> and <code>src/DeepThought.bs</code> in an
editor, preferably in a separate editor window.</p>
</div>
<hr>
<div class="sect3">
<h4 id="_interfaces_and_interface_types">4.3.1. Interfaces and interface types</h4>
<div class="paragraph">
<p>In the <code>DeepThought.bs</code> we see this module type declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mkDeepThought :: Module  DeepThought_IFC</code></pre>
</div>
</div>
<div class="paragraph">
<p>This says the module&#8217;s <em>interface</em> has the type <code>DeepThought_IFC</code>.  An
interface of a module defines the <em>methods</em> by which the environment
interacts with the module (similar to an object interface in an
object-oriented programming language).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In the first version of this Hello World example, the interface
  type was the predefined type <code>Empty</code>, which is an interface with no
  methods.  This is typically used in top-level modules.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This particular interface is defined a few lines earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>interface DeepThought_IFC =
    getAnswer :: ActionValue  (Int 32)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It has a single method, <code>getAnswer</code> whose type is the monadic type
<code>ActionValue (Int 32)</code> it is an Action that, when performed, returns a
value of type <code>Int 32</code> (which is the type of 32-bit signed integers).</p>
</div>
<div class="paragraph">
<p>Returning to the module value definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mkDeepThought =
  module
    interface DeepThought_IFC
        getAnswer = return 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>we see the implementation of the <code>getAnswer</code> method: it is simply the
monadic expression <code>return 42</code>.</p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_synthesis_boundaries">4.3.2. Synthesis boundaries</h4>
<div class="paragraph">
<p>Just preceding the module definition we have the following <code>bsc</code> compiler directive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{-# verilog mkDeepThought #-}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both the source code (BH/BSV) and <code>bsc</code> 's target code (Verilog) have
the concept of &#8220;modules&#8221; and &#8220;module hierarchy&#8221;, and they are in
fact congruent, i.e., each of them has the same concept of module
instantiations and module hierarchy (about which we&#8217;ll see more in a
moment).  The above directive instructs <code>bsc</code> please to <em>preserve</em>
this module boundary into the generated Verilog when compiling this
module.  Without this directive, a BH/BSV module is in-lined wherever
it is instantiated.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This directive is not universally applicable to <em>any</em> BH/BSV
  module.  A Verilog module&#8217;s interface consists of wires (individual
  wires, or bundles of wires called <em>buses</em>), i.e., they can only
  carry values for which we&#8217;ve defined a concrete hardware
  representation in bits.  BH/BSV modules interfaces can carry
  polymorphic values, higher-order functions etc., for which we
  typically do not have a concrete representation in bits; such
  modules cannot carry this directive.  Thus, the Verilog module
  hierarchy produced from a BH/BSV program is typically a coarser
  projection of the source hierarchy.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_packages_imports_and_files">4.3.3. Packages, imports, and files</h4>
<div class="paragraph">
<p>At the top of <code>DeepThought.bs</code> we have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>package DeepThought where</code></pre>
</div>
</div>
<div class="paragraph">
<p>and in <code>Top.bs</code> we have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>import DeepThought</code></pre>
</div>
</div>
<div class="paragraph">
<p>BH/BSV&#8217;s <code>package</code> construct plays the same role <code>module</code> in Haskell.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every file in <code>Foo.bs</code> (BH) or <code>Foo.bsv</code> (BSV) is a package, and
must be introduced by the <code>package Foo</code> construct</p>
<div class="ulist">
<ul>
<li>
<p>A file can only contain one package.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A package can <em>import</em> a package <code>Foo</code> by saying <code>import Foo</code> (we&#8217;ll
see that shortly in <code>Top.bs</code>).  The reason for the identity
between the package name and the file name is that <code>bsc</code> uses the
package name to search the file system for a file with that name
with extension <code>.bs</code> of <code>.bsv</code>.</p>
</li>
<li>
<p>When package <code>Foo</code> is imported, the identifiers defined there become
visible and usable in the importing package.</p>
<div class="ulist">
<ul>
<li>
<p>The vocabulary for selective export and import is not as rich
as in Haskell; please see <a href="#RefGuide">[RefGuide]</a> for details.</p>
</li>
</ul>
</div>
</li>
<li>
<p>As in Haskell, if you import two packages which both define the same
identifier <code>x</code>, you can disambiguate them using the package name.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>package</code> vs. <code>module</code> dissonance with Haskell is
  unfortunate.  In the hardware-design universe, the word <code>module</code> has
  long been used in Verilog and SystemVerilog with the meaning you see
  here; we decided to keep this convention because of familiarity for
  hardware designers (who typically have no exposure to Haskell.)
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_separate_compilation">4.3.4. Separate compilation</h4>
<div class="paragraph">
<p>Earlier, when compiling a BH program, the command we invoked had the <code>-u</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ bsc -u -sim ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This flag tells <code>bsc</code> to chase the &#8220;import&#8221; s transitively from the
specified top-level file/package, and compile each such file if it is
out-of-date, i.e., if the source has changed since the
compiler-intermediate files were last created.  This is a bit of
<code>Makefile</code>-like dependency-tracking built into <code>bsc</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
BH and BSV are completely <em>interoperable</em> at package
  granularity, i.e., a package written in BH can import a package
  written in BSV and vice versa.  We will make use of this in later
  examples when we import, from BH, code for a RISC-V CPU that happens
  to be written in BSV.  The Bluespec standard libraries are a mix:
  some packages are written in BH, some in BSV.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_instantiating_modules_and_invoking_their_methods">4.3.5. Instantiating modules and invoking their methods</h4>
<div id="ModuleInstantiation" class="paragraph">
<p>In <code>Top.bs</code> the module is now defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mkTop =
  module
    deepThought &lt;- mkDeepThought    -- (A)
    rules
        "rl_print_answer": when True ==&gt; do
            x &lt;- deepThought.getAnswer
            $display "\n\n***** Deep Thought says: Hello, World! *****"
            $display "      And the answer is: %0d (or, in hex: 0x%0h)\n"  x  x
            $finish</code></pre>
</div>
</div>
<div class="paragraph">
<p>In line (A), we <em>instantiate</em> the module mkDeepThought.  As the <code>&#8592;</code>
notation suggests, this is a monadic statement.  The right-hand-side
is an expression of type <code>Module DeepThought</code>; the action performed is
to instantiate the module and return it&#8217;s interface, of type
<code>DeepThought_IFC</code>.  Thus, <code>deepThought::DeepThought_IFC</code>.</p>
</div>
<div class="paragraph">
<p>In the first line of the rule, the <code>&#8592;</code> again suggests a monadic
statement. The right-hand side is of type <code>ActionValue (Int 32)</code>; it
performs the action and returns a value of type <code>Int 32</code>; thus <code>x::Int 32</code>.</p>
</div>
<div class="paragraph">
<p>The two major monads used in BH/BSV are the <em>module</em> monad and the
<em>action</em> monad (both of which you see in the above example):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The module monad concerns STRUCTURE, or circuit description.  It
is evaluated by <code>bsc</code> to <em>elaborate</em> a module hierarchy, starting
with a top-level module, elaborating the modules it instantiates,
elaborating the modules that those modules instantiate, and so on,
recursively.</p>
</li>
<li>
<p>The action monad concerns BEHAVIOR--- it&#8217;s action is performed
during circuit execution.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The module monad is actually a polymorphic <code>IsModule</code> typeclass,
    so you can customize the module syntax to collect items other than
    just sub-module instances, rules and interfaces.  For example, you
    can collect <code>trace</code> output to be captured in modules deep in the
    module hierarchcy and streamed out to be recorded somewhere.  Or
    you could collect &#8220;control and status&#8221; registers from deep
    within the module hierarchy, for dynamic configuration and
    monitoring of a hardware design.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_let_s_do_it_compile_link_and_simulate_the_example">4.3.6. Let&#8217;s do it! Compile, link and simulate the example:</h4>
<div class="paragraph">
<p>Using Bluesim:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Eg020b_HelloWorld
$ make  b_compile  b_link  b_sim</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using Bluesim:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ make  v_compile  v_link  v_sim</code></pre>
</div>
</div>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="_hello_world_version_c_state_and_time">4.4. Hello World! Version (c): State and Time</h3>
<div class="paragraph">
<p>Please visit this directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ cd Examples/Eg020c_HelloWorld</code></pre>
</div>
</div>
<div class="paragraph">
<p>And bring up the files <code>src/Top.bs</code> and <code>src/DeepThought.bs</code> in an
editor, preferably in a separate editor window.</p>
</div>
<div class="paragraph">
<p>This version of Hello World! adds a temporal dimension.  The <code>mkTop</code>
module will request an answer from the <code>mkDeepThought</code> module, which
now has a <em>state machine</em> so that it &#8220;thinks&#8221; for &#8220;7.5 Million
Years&#8221; before yielding its answer of 42.  Meanwhile, <code>mkTop</code> waits.<sup>1</sup></p>
</div>
<div class="paragraph">
<p><sup>1</sup> We are of course paying homage to the book <em>The Hitchhiker’s Guide
to the Galaxy</em> by Douglas Adams (1979). In the book, a supercomputer
named Deep Thought is asked to calculate the Answer to the Ultimate
Question of Life, the Universe, and Everything. After 7.5 million
years, it answers: &#8220;42&#8221;.</p>
</div>
<hr>
<div class="sect3">
<h4 id="_action_actionvalue_and_value_interface_methods">4.4.1. Action, ActionValue and Value interface methods</h4>
<div class="paragraph">
<p>In <code>DeepThought.bs</code> we see a new interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>interface DeepThought_IFC =
   whatIsTheAnswer :: Action
   getAnswer       :: ActionValue (Int 32)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new method <code>whatIsTheAnswer</code> has type <code>Action</code>, which is a pure
side-effect.  You can think of it as equivalent to <code>ActionValue Void</code>,
i.e., the return value carries no interesting information.  <code>mkTop</code>
will use this method to request an answer.</p>
</div>
<div class="paragraph">
<p>The <code>getAnswer</code> method has the same type as before, but we will see
that it won&#8217;t yield an answer immediately (not for &#8220;7.5 million
years&#8221;).</p>
</div>
<div class="paragraph">
<p>In general, all methods will have one of three return-types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Action</code> : a pure side effect (an action)</p>
</li>
<li>
<p><code>ActionValue</code> <em>t</em> : a side effect (an action) plus a returned value of type <em>t</em></p>
</li>
<li>
<p><em>t</em> : a pure value with no side effect (no action)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
since a rule&#8217;s type is <code>Bool</code>, it is guaranteed by the type-system to have no actions/effects
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_algebraic_types">4.4.2. Algebraic types</h4>
<div class="paragraph">
<p>In <code>DeepThought.bs</code> we see a new type definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>data State_DT = IDLE | THINKING | ANSWER_READY
     deriving (Eq, Bits, FShow)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>deriving Eq</code> is just like Haskell, i.e., the compiler defines the
<code>Eq</code> typeclass operators <code>==</code> and <code>/=</code> for this new <code>State_DT</code> type.</p>
</li>
<li>
<p>The <code>Bits t n</code> typeclass has two functions to convert a type to bits and back.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    pack   :: t     -&gt; Bit n
    unpack :: Bit n -&gt; t</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each constructor of an algebraic type, this is canonically a
concatenation of the bits for the component type with just enough bits
to represent the constructor uniquely, possibly with some padding of
&#8220;don&#8217;t care&#8221; bits so that each disjunct has exactly the same number
of bits.  Our example will pack into a <code>Bit 2</code> type with codings 0, 1
and 2 for the three disjuncts.</p>
</div>
</li>
<li>
<p>The <code>FShow</code> typeclass is similar to <code>Show</code> in Haskell, and provides one function:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    fshow  :: t -&gt; Fmt</code></pre>
</div>
</div>
<div class="paragraph">
<p>A value of <code>Fmt</code> type is a pre-formatted object that can be used as an
argument to <code>$display</code> and <code>$write</code>.  For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    $display "Current state  %0d, next state"  IDLE  (fshow THINKING)</code></pre>
</div>
</div>
<div class="paragraph">
<p>will print &#8220;Current state 0, next state THINKING&#8221;.  I.e., without
fshow, it just prints the value of the bit reprenstation, but with
fshow it prints the symbolic value.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Instead of <code>$display</code> which actually prints things, you can use
<code>$format</code> which is a pure function with the same kind of arguments as
$display, and which returns a <code>Fmt</code> object.  Further, values of <code>Fmt</code>
type can be concatenated with <code>+</code> to create new <code>Fmt</code> values.  Thus,
you can write functions that nicely format complex types.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_registers_instantiation_initializing_and_operations">4.4.3. Registers: Instantiation, initializing, and operations</h4>
<div class="paragraph">
<p>In <code>DeepThought.bs</code>, in module <code>mkDeepThought</code> we first see the instantiation of a &#8220;register&#8221;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    rg_state_dt      :: Reg  State_DT &lt;- mkReg IDLE</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a module instantiation, just like the one we saw earlier
(instantiation of <code>mkDeepThought</code> in <code>mkTop</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In BH/BSV, registers are not special, they are just pre-defined
    modules that are found at the leaves of the module hierarchy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The right-hand side has type <code>Module (Reg State_DT)</code>; the monadic <code>&#8592;</code>
instantiates the module and returns the interface of type <code>Reg
State_DT</code> which is bound to the identifier <code>rg_state_dt</code>.  <code>mkReg</code> has
type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    mkReg :: t -&gt; Module (Reg t)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The argument is the &#8220;initial value&#8221; of the register, i.e., the value
it has when execution begins.  <code>Reg t</code> is just an interface type with two methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    _read  :: Reg t -&gt; t
    _write :: Reg t -&gt; t -&gt; Action</code></pre>
</div>
</div>
<div class="paragraph">
<p>Normally invoking a method <em>meth</em> in interface <em>ifc</em> is written with
the traditional &#8220;dot&#8221; notation: <em>ifc.meth</em> . Writing <code>._read</code> and
<code>._write</code> for registers can be quite tedious, so there are some
syntactic shorthands.  For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    rg_half_millenia._write (rg_half_millenia._read + 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be written with this syntactic shorthand:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    rg_half_millenia := rg_half_millenia + 1</code></pre>
</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_local_values_bit_selection_and_combinational_circuits">4.4.4. Local values, bit selection and combinational circuits</h4>
<div class="paragraph">
<p>In <code>DeepThought.bs</code>, we next see instantiation of another register
which we use to count &#8220;half-millenium&#8221; steps, initialized to zero.
It is 4 bits wide, so it can count from 0 to 15 (= 7.5 millenia).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    rg_half_millenia :: Reg  (Bit 4)  &lt;- mkReg 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we see some local definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    let millenia       = rg_half_millenia [3:1]
    let half_millenium = rg_half_millenia [0:0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The notation <em>e</em> <code>[3:1]</code> selects bits 1 through 3 of the value of <em>e</em>,
which must have <code>Bit n</code> type, and has type <code>Bit 3</code>.  Bits are numbered
in &#8220;little-endian&#8221; order, with 0 being the least-significant bit.</p>
</div>
<div class="paragraph">
<p>The notation <em>e</em> <code>[0:0]</code> can be used to select a single bit, and has type <code>Bit 1</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Any pure expression (that is not an <code>Action</code> or <code>ActionValue</code>
    type) represents a so-called &#8220;combinational circuit&#8221;, i.e., it
    can be compiled to an acyclic circuit of AND, OR and NOT gates.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_interface_method_conditions_and_actions">4.4.5. Interface method conditions and actions</h4>
<div class="paragraph">
<p>In <code>DeepThought.bs</code>, the first interface method is implemented like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        whatIsTheAnswer = rg_state_dt := THINKING
                          when (rg_state_dt == IDLE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second line is the &#8220;method condition&#8221;, which states when the
method is eligible to be invoked by the environment.  When it is
invoked, it performs the action described in the first line (a
register assignment).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
BH/BSV methods differ from methods in object-oriented
  languages precisely because of rule conditions, which act as
  &#8220;guards&#8221; on the methods.  As we shall soon see, every method is
  invoked by a rule (either directly, or indirectly via other
  methods); rules are the fundamental &#8220;processes&#8221; of BH/BSV.  When a
  method condition is false, it has the effect of &#8220;stalling the
  process&#8221;, i.e., the rule from which it is invoked cannot fire.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_rule_conditions">4.4.6. Rule conditions</h4>
<div class="paragraph">
<p>In <code>DeepThought.bs</code>, the module still has only one rule, called
<code>rl_think</code>.  It has a non-constant <em>rule condition</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    (rg_state_dt == THINKING)</code></pre>
</div>
</div>
<div class="paragraph">
<p>which limits when the rule is allowed to fire.  It cannot fire when
execution begins, since <code>rg_state_dt</code> is initialized to <code>IDLE</code>.
However, when method <code>whatIsTheAnswer</code> is invoked, the method sets the
state to <code>THINKING</code>, which enables the rule condition and allows it to
fire.</p>
</div>
<div class="paragraph">
<p>When the rule does fire, it issues message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        $write  "        DeepThought: ... thinking ... (%0d"  millenia
        if (half_millenium == 1) then $write  ".5" else noAction
        $display  " million years)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only difference between <code>$write</code> and <code>$display</code> is that the former
does not emit an end-of-line while the latter does (these are
long-standing in Verilog).</p>
</div>
<div class="paragraph">
<p>This conditional expression (both arms are of type Action) either
increments our counter or changes the state to <code>ANSWER_READY</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        if (rg_half_millenia == 15) then
            rg_state_dt := ANSWER_READY
         else
            rg_half_millenia := rg_half_millenia + 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thus, the rule will fire repeatedly, each time incrementing
<code>rg_half_millenia</code>, until it finally assigns <code>ANSWER_READY</code> to
<code>rg_state_dt</code>.  At this point the rule condition is false and so it
cannot fire any more.</p>
</div>
<hr>
<div class="paragraph">
<p>At this point, the method condition of the second method is enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        getAnswer = do
                        rg_state_dt      := IDLE
                        rg_half_millenia := 0
                        return 42
                    when (rg_state_dt == ANSWER_READY)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the environment invokes this method, it performs its actions,
namely restoring the registers to their initial values, and it returns
the value 42.</p>
</div>
<hr>
<div class="paragraph">
<p>Turning to <code>Top.bs</code>, we see that it has two rules, the latter being
the same as in the previous version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>      "rule rl_ask": when True ==&gt; do
        $display  "Asking the Ultimate Question of Life, The Universe and Everything"
        deepThought.whatIsTheAnswer

      "rl_print_answer": when True ==&gt; do
        x &lt;- deepThought.getAnswer
        $display  "Deep Thought says: Hello, World! The answer is %0d."  x
        $finish</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us follow the &#8220;flow&#8221; through the program execution.  The program
has a total of three rules, two in <code>mkTop</code> and one in <code>mkDeepThought</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At start of execution, only one rule can fire:</p>
<div class="ulist">
<ul>
<li>
<p><code>rl_ask</code> can fire, because its own rule condition is true and
the conditions on the method it invokes,
<code>deepThought.whatIsTheAnswer</code>, is true.</p>
</li>
<li>
<p><code>rl_print_answer</code> cannot fire because even though the rule
condition is true the method condition on <code>deepThought.getAnswer</code> is not.</p>
</li>
<li>
<p><code>rl_think</code> cannot fire because its rule condition is false.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>rl_ask</code> fires, and invokes the <code>deepThought.whatIsTheAnswer</code> method.<br>
At this point,  again, only one rule can fire:</p>
<div class="ulist">
<ul>
<li>
<p><code>rl_think</code> can fire because its rule condition is true.</p>
</li>
<li>
<p>The other two rules cannot because the method conditions of their methods invoked are false.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>rl_think</code> fires, and it increments the counter.  This repeats 15 times until, again, only one rule can fire:</p>
<div class="ulist">
<ul>
<li>
<p><code>rl_ask</code> cannot fire (method condition false)</p>
</li>
<li>
<p><code>rl_think</code> cannot fire (rule condition false)</p>
</li>
<li>
<p><code>rl_print_answer</code> can fire (rule condition and method condtion true)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>rl_print_answer</code> fires, prints the answer, and the execution terminates.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_let_s_do_it_compile_link_and_simulate_the_example_2">4.4.7. Let&#8217;s do it! Compile, link and simulate the example:</h4>
<div class="paragraph">
<p>Using Bluesim or Verilog sim:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Eg020c_HelloWorld
$ make b_compile b_link b_sim
...
Asking the Ultimate Question of Life, The Universe and Everything
        DeepThought: ... thinking ... (0 million years)
        DeepThought: ... thinking ... (0.5 million years)
        DeepThought: ... thinking ... (1 million years)
        DeepThought: ... thinking ... (1.5 million years)
        DeepThought: ... thinking ... (2 million years)
        DeepThought: ... thinking ... (2.5 million years)
        DeepThought: ... thinking ... (3 million years)
        DeepThought: ... thinking ... (3.5 million years)
        DeepThought: ... thinking ... (4 million years)
        DeepThought: ... thinking ... (4.5 million years)
        DeepThought: ... thinking ... (5 million years)
        DeepThought: ... thinking ... (5.5 million years)
        DeepThought: ... thinking ... (6 million years)
        DeepThought: ... thinking ... (6.5 million years)
        DeepThought: ... thinking ... (7 million years)
        DeepThought: ... thinking ... (7.5 million years)
Deep Thought says: Hello, World! The answer is 42.</code></pre>
</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_visualizing_the_hardware_for_code_mktop_code_rule_level_view">4.4.8. Visualizing the hardware for <code>mkTop</code>: rule-level view</h4>
<div class="paragraph">
<p>We continue to reinforce, as in Fig.<a href="#Haskell_vs_Bluespec">Haskell vs. Bluespec BH/BSV</a>, that we
are describing <em>actual hardware</em>, not some representation in memory
manipulated by a program on a conventional computer.</p>
</div>
<div id="Hello_World_C_mkTop_0" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Hello_World_C_mkTop_0.png" alt="Hello World C mkTop 0" width="600">
</div>
<div class="title">Figure 6. A visualization of the hardware for <code>mkTop</code>: rule level</div>
</div>
<div class="paragraph">
<p>In the figure, we show module instances as sharp-cornered rectangles
in blue, and rules and methods as rounded-cornered rectancles in
yellow.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Our choice of yellow round-cornered rectangles for
  depicting rules and methods is deliberate.  Both have Bool
  <em>conditions</em> and <em>bodies</em>.  Conceptually, the overall condition
  determining whether a rule fires is both its own condition as well
  as the condtions on the emthods it invokes.  The overall body of a
  rule is both its own body as well as the bodies of the methods it
  invokes.  You can think of the source code as a way to <em>compose</em> a
  logical composite rule from components: a syntactic rule in a module
  plus, the methods it invokes in other modules, and transitively, the
  methods that those methods may invoke, etc.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_visualizing_the_hardware_for_code_mktop_code_verilog_rtl_view">4.4.9. Visualizing the hardware for <code>mkTop</code>: Verilog RTL view</h4>
<div id="Hello_World_C_mkTop_1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Hello_World_C_mkTop_1.png" alt="Hello World C mkTop 1" width="600">
</div>
<div class="title">Figure 7. A visualization of the hardware for <code>mkTop</code>: Verilog RTL level</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>RDY</code> signals of the methods are the method conditions</p>
</li>
<li>
<p>Each rule combines the <code>RDY</code> signal with its own rule condition,
resulting finally in a <code>WILL_FIRE</code> signal indicating when the rule
will fire.</p>
</li>
<li>
<p>The <code>WILL_FIRE</code> signal of a rule activates all teh <code>ENA</code> signals of
Action and ActionValue methods that it invokes.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_visualizing_the_hardware_for_code_mkdeepthought_code_rule_level_view">4.4.10. Visualizing the hardware for <code>mkDeepThought</code>: rule-level view</h4>
<div id="Hello_World_C_mkDeepThought_0" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Hello_World_C_mkDeepThought_0.png" alt="Hello World C mkDeepThought 0" width="800">
</div>
<div class="title">Figure 8. A visualization of the hardware for <code>mkTop</code>: rule level</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_visualizing_the_hardware_for_code_mkdeepthought_code_verilog_rtl_view">4.4.11. Visualizing the hardware for <code>mkDeepThought</code>: Verilog RTL view</h4>
<div id="Hello_World_C_mkDeepThought_1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Hello_World_C_mkDeepThought_1.png" alt="Hello World C mkDeepThought 1" width="800">
</div>
<div class="title">Figure 9. A visualization of the hardware for <code>mkDeepThought</code>: Verilog RTL level</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_waveforms_vcd_files_and_waveform_viewers">4.4.12. Waveforms: VCD files and Waveform viewers</h4>
<div class="paragraph">
<p>Now let&#8217;s run the Bluesim simulation with the <code>-V</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ ./mkTop_b_sim  -V</code></pre>
</div>
</div>
<div class="paragraph">
<p>or the IVerilog simulation using the <code>+bscvcd</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ ./mkTop_v_sim  +bscvcd</code></pre>
</div>
</div>
<div class="paragraph">
<p>In each case, it will produce a file called <code>dump.vcd</code>.  VCD stands
for &#8220;Value Change Dump&#8221;, a standard feature of hardware simulations;
it is essentially a dump of all 0&#8594;1 and 1&#8594;0 transitions in the
circuit, and thus represents a detailed &#8220;time trace&#8221; of hardware
behavior.</p>
</div>
<div class="paragraph">
<p>If you have installed the <code>GtkWave</code> application (free, open source,
available standardly with most package installers, such as <code>apt-get
install gtkwave</code> on Linux), you can view the VCD file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ gtkwave  dump.vcd</code></pre>
</div>
</div>
<div class="paragraph">
<p>The GUI has various controls to select which waves and what time range
you want to see.  Here is a snapshot:</p>
</div>
<div id="Hello_World_C_Waves" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Hello_World_C_Waves.png" alt="Hello World C Waves">
</div>
<div class="title">Figure 10. Waveforms from Hello World!</div>
</div>
<div class="paragraph">
<p>The top-left window shows the module hierarchy.  The figure shows
<code>deepThought</code> inside <code>top</code> (which, in turn, is inside a boilerplate
<code>main</code> provided by the <code>bsc</code> libraries).  When you click on a module
instance, the window below it shows the signals in that
module. Selecting a signal and clicking <code>Append</code> brings up the signal
in the main signal window.  We have selected a few signals of interest
for this example.</p>
</div>
<div class="paragraph">
<p>The top waveform is the clock signal <code>CLK</code>.</p>
</div>
<div class="paragraph">
<p>The next two waves show the method condition of <code>whatIsTheAnswer</code>
(<code>CAN_FIRE_&#8230;&#8203;</code>) and overall condition of the <code>rl_ask</code> rule
(<code>WILL_FIRE_&#8230;&#8203;</code>).  You can see that they are enabled (true) on the
first clock, and false subsequently.</p>
</div>
<div class="paragraph">
<p>The next two waves show the value of the <code>rg_state_dt</code> and
<code>rg_half_millenia</code> registers.  The from starts at 0 (encoding of
<code>IDLE</code>), moves to 1 (<code>THNKING</code>) and finally to 2 (<code>ANSWER_READY</code>).
The latter starts at 0 and increments up to 15 (hex 0xF).</p>
</div>
<div class="paragraph">
<p>The final two waves show the method condition for <code>getAnswer</code> and the
overall rule condition for <code>rl_print_answer</code>).  These are false until
<code>rg_state_dt</code> becomes <code>ANSWER_READY</code>,</p>
</div>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="_simulation_and_synthesis_semantics_are_the_same_in_bh_bsv">4.5. Simulation and Synthesis semantics are the same in BH/BSV</h3>
<div class="ulist">
<ul>
<li>
<p>You should see exactly the same waveforms whether you use Bluesim,
IVerilog simulation, or any other Verilog simulator.</p>
</li>
<li>
<p>In traditional Hardware Design Languages (HDLs) like Verilog,
SystemVerilog and VHDL, there can be a difference between what you see
in simulation (VCD viewing) and what you see in real hardware (hooking
up an oscilloscope to the actual electronic circuit).  This is because
these languages are defined based on a <em>simulation</em> model which is
more expressive than actual hardware (you can specify arbitrary time
intervals within clocks, signals can be sampled at arbitrary time
points within clocks, etc.).</p>
<div class="paragraph">
<p>To eliminate nasty surprises, one is advised to stick to the so-called
&#8220;synthesizable&#8221; subset of Verilog/ SystemVerilog/ VHDL, which avoids
those tricky constructs.</p>
</div>
<div class="paragraph">
<p>In BH/BSV there is no such difference between simulation and hardware
semantics.</p>
</div>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="HDLS_vs_HLS">4.6. HLHDLs vs. HLS: precise specification of micro-architecture</h3>
<div class="ulist">
<ul>
<li>
<p>Please observe, in the above diagrams, that the Rule-level view and
the Verilog RTL view have the same broad structure, differing only
in the level of detail.</p>
</li>
<li>
<p>This is why it is not hard to correlate Verilog simulation and VCD
waves produced by Verilog simulation to BH/BSV source code.</p>
</li>
<li>
<p>This is <em>quite different</em> from the situation with so-called HLS
(High Level Synthesis).  In HLS, the source code is C/C (with the
execution semantics of C/C), and the HLS tool produces a
microarchitecture for you (modules, logic, connections).  The
designer can provide directives that influence the
microarchitecture, but does not specify the microarchitecture
precisely.</p>
</li>
<li>
<p>In HLHDLs like BH/BSV and Chisel, you specify the microarchitecture
precisely.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_numeric_types_and_kinds_in_bh_bsv">4.7. Numeric types and kinds in BH/BSV</h3>
<div class="paragraph">
<p>In the previous examples, we saw types such as <code>Int 32</code> and <code>Bit 4</code>,
for 32-bit signed integers and 4-bit-wide bit vectors.  In BH/BSV,
there are several <em>kinds</em> of types.  Most types we use, such as
scalars, vectors, functions, and so on are of the ordinary kind
(notated <code>*</code> in code).</p>
</div>
<div class="paragraph">
<p>Another kind is the numeric kind (notated <code>#</code> in code), as in the
above examples.  Though they look like numeric values, they only live
in type expressions, and should not be confused with numeric values.</p>
</div>
<div class="paragraph">
<p>Only fixed-width types are supported in hardware.  BH/BSV has an
unbounded <code>Integer</code> type, but they can only be used for static
elaboration, i.e., structural description, not for values represented
in hardware.</p>
</div>
<div class="paragraph">
<p>Arithmetic on fixed-width types wraps around silently, as it does in
hardware, so you need to be careful about this.</p>
</div>
<div class="paragraph">
<p>BH/BSV has strong type-checking on numeric types, and there are no
automatic coercions to silently extend or truncate types to different
widths.  Thus, if a context expects a <code>Bit 4</code> and the expression there
has type <code>Bit 5</code>, the compiler will report it as a type error.  You
have to explicitly use the primitive functions <code>zeroExtend</code> and
<code>signExtend</code> and <code>truncate</code> if you wish to convert the width of a
value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In software we are used to thinking of a few, fixed,
byte-multiple sizes for integers, typically from 1 to 4 bytes, because
that&#8217;s what our underlying processors and memories use.  In hardware
design, there is nothing special about byte-multiples, bytes, 64-bit
width limits, etc.; one typically picks exactly the bit-width needed
for purpose.  In such a scenario, we are skating much closer to the
edge concerning wraparounds, overflows etc., so one needs to be much
more careful about this.  BH/BSV&#8217;s strong type-checking on numeric
types are a great benefit for this.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Functions and types can be polymorphic on numeric types, and BH/BSV
also has typeclasses on numeric types that encode limited arithmetic
on such types.  Thus, for example, we can express (and typecheck) a
function that concatenates values of type <code>Bit m</code> and <code>Bit n</code> to
produce a value of type <code>Bit n+m</code>.  Here, <code>n</code> and <code>m</code> are type
variables of numeric kind.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introducing_concurrency_with_bubblesort_as_example">5. Introducing Concurrency with Bubblesort as Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Everyone who&#8217;s learned programming is familiar with Bubblesort.  It&#8217;s
a very inefficient sorting algorithm, but is useful as a pedagogical
tool to learn some basic programming constructs.  Here, we&#8217;ll use it
as a vehicle to introduce concurrency in BH/BSV.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll start with a traditional sequential version, then add
concurrency, and then generalize the code in various ways
(polymorphism and type-dependent ordering, size of array, etc.).</p>
</div>
<hr>
<div class="sect2">
<h3 id="_bubblesort_version_a_sequential_a_finite_state_machine">5.1. Bubblesort Version (a): Sequential (a finite state machine)</h3>
<div class="paragraph">
<p>Please visit this directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ cd  Examples/Eg030a_Bubblesort</code></pre>
</div>
</div>
<div class="paragraph">
<p>and examine the source files in an editor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>src/Top.bs
src/Bubblesort.bs</code></pre>
</div>
</div>
<div class="paragraph">
<p>The overall strategy (very artificial!) is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the top-level module <code>mkTop</code> (in <code>Top.bs</code>), we will generate
(sequentially) five random values of type <code>Int 32</code> and feed them
(sequentially) into the <code>mkBubbleSort</code> module (in <code>Bubblesort.bs</code>).</p>
</li>
<li>
<p><code>mkBubblesort</code> will then sort the numbers and indicate completion</p>
</li>
<li>
<p><code>mkTop</code> will then drain the values (sequentially) in sorted order,
and print the results.</p>
</li>
</ul>
</div>
<hr>
<div class="sect3">
<h4 id="__code_mkbubblesort_code_interface">5.1.1. <code>mkBubblesort</code>: interface</h4>
<div class="paragraph">
<p>We start by defining its interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>interface Sort_IFC =
    put :: (Int 32) -&gt; Action
    get :: ActionValue  (Int 32)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>put</code> method will be invoked repeatedly by <code>mkTop</code>, supplying an <code>Int 32</code>
argument each time, to load the sorter.</p>
</li>
<li>
<p>Finally, the <code>get</code> method will be invoked repeatedly by <code>mkTop</code>,
each time extracting an <code>Int 32</code> value, in sorted order.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="__code_mkbubblesort_code_state_elements">5.1.2. <code>mkBubblesort</code>: state elements</h4>
<div class="paragraph">
<p>In the <code>mkBubblesort</code> module, we instantiate a number of registers to
hold the &#8220;state&#8221; of the module.</p>
</div>
<div class="paragraph">
<p>This register will be used to count-in and count-out inputs, so we
know when we&#8217;ve received the correct number for inputs and have
delivered the correct number of outputs.  The register contents has
type <code>UInt 3</code> (unsigned 3-bit integer) which is adequate for our
purpose (or we could have used <code>Bit 3</code> directly here):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        rg_j :: Reg (UInt  3) &lt;- mkReg  0</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The intitial value must have the register-content type <code>UInt 3</code>;
  so what is the type of <code>0</code>?  It&#8217;s actually of type <code>Integer</code>
  (unbounded integers), but BH/BSV plays the same Haskell trick of
  applying <code>fromInteger</code> implicitly to integer literals, and typeclass
  machinery will produce the required <code>UInt 3</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, because we&#8217;re going to imitate the classical sequential program,
we&#8217;re going to use a &#8220;Program Counter&#8221; to sequence it through the steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        rg_pc :: Reg  (Bit  3) &lt;- mkReg  0</code></pre>
</div>
</div>
<div class="paragraph">
<p>This register will remember, in each sweep through the array, whether
or not any swaps were performed, in order to detect termination (no
swaps &#8658; all sorted):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        rg_swapped :: Reg  Bool &lt;- mkRegU</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the registers holding the values to be sorted.<sup>1</sup> We don&#8217;t
bother initializing them since we&#8217;ll be loading them before sorting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        x0 :: Reg  (Int  32) &lt;- mkRegU
        x1 :: Reg  (Int  32) &lt;- mkRegU
        x2 :: Reg  (Int  32) &lt;- mkRegU
        x3 :: Reg  (Int  32) &lt;- mkRegU
        x4 :: Reg  (Int  32) &lt;- mkRegU</code></pre>
</div>
</div>
<div class="paragraph">
<p><sup>1</sup> <em>If you are squirming at this tedious repetition: don&#8217;t worry, we&#8217;ll use a vector, soon.</em></p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="__code_mkbubblesort_code_input">5.1.3. <code>mkBubblesort</code>: input</h4>
<div class="paragraph">
<p>As <code>mkTop</code> repeatedly calls the <code>put</code> method to deliver input values,
we&#8217;ll &#8220;shift them in&#8221; to the holding registers.  This help-function
expresses the idea:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        let shift :: Int 32 -&gt; Action
            shift y = action { x0 := x1; x1 := x2; x2 := x3; x3 := x4; x4 := y }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, these are five <em>simultaneous</em> actions; there is no semantic
sequencing between them.  Think of them as five parallel assignments.</p>
</div>
<div class="paragraph">
<p>Here is the <code>put</code> method that delivers input values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>            put x = do
                        shift  x
                        rg_j := rg_j + 1
                        if1 (rg_j == 4)
                            action { rg_pc := 1; rg_swapped := False }
                    when (rg_pc == 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is only enabled when <code>rg_pc</code> is 0 (we&#8217;ll use non-zero as an
indication of &#8220;busy&#8221;).  It shifts the new value <code>x</code> in and
increments <code>rg_j</code>. On the last value (<code>rg_j==4</code>), we set <code>rg_pc</code> to 1
and initialize <code>rg_swapped</code> to False.</p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="__code_mkbubblesort_code_sorting">5.1.4. <code>mkBubblesort</code>: sorting</h4>
<div class="paragraph">
<p>The sorting behavior is expressed by a series of 5 rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>            "rl_swap_0_1": when (rg_pc == 1)
             ==&gt; do
                    if1 (x0 &gt; x1)
                        action { x0 := x1; x1 := x0; rg_swapped := True }
                    rg_pc := 2

            "rl_swap_1_2": when (rg_pc == 2)
             ==&gt; do
                    if1 (x1 &gt; x2)
                        action { x1 := x2; x2 := x1; rg_swapped := True }
                    rg_pc := 3

            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each rule&#8217;s condition only enables it to fire when <code>rg_pc</code> has a
particular value.  It swaps an adjacent pair of registers if they are
in the wrong order, and advances <code>rg_pc</code> to enable the next rule.</p>
</div>
<div class="paragraph">
<p>Note: in a traditional imperative language, a swap usually needs an
extra temporary variable because assignment statements are sequential:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tmp := x1
x1  := x0
x0  := tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>In BH/BSV, the actions in an Action block are all <em>simultaneous</em>
(parallel assignments), so there is no need for an intermediate
temporary variable.</p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="__code_mkbubblesort_code_termination">5.1.5. <code>mkBubblesort</code>: termination</h4>
<div class="paragraph">
<p>If any <code>rl_swap</code> actually performs a swap, it will have set
<code>rg_swapped</code> true.  We use this in the final rule to decide whether to
loop or signal completion (by setting <code>rg_pc</code> to 6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>            "rl_loop_or_exit": when (rg_pc == 5)
             ==&gt; do
                    if (rg_swapped) then
                        action { rg_swapped := False; rg_pc := 1 }
                     else
                        rg_pc := 6</code></pre>
</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="__code_mkbubblesort_code_output">5.1.6. <code>mkBubblesort</code>: output</h4>
<div class="paragraph">
<p>Output is delivered with repeated invocations of the <code>get</code> method.
This is only enabled when <code>rg_pc</code> is 6 and there are &gt; 0 elements
remaining in the register array (<code>rg_j /= 0</code>).  It returns <code>x0</code> (the
smallest of the remaining sorted values), but its actions also shift
the array, decrement <code>rg_j</code>, and, on the last value, resets <code>rg_pc</code> to
0 getting the module ready for its next use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>            get   = do
                        shift  _
                        rg_j := rg_j - 1
                        if1 (rg_j == 1) (rg_pc := 0)
                        return x0
                    when ((rg_j /= 0) &amp;&amp; (rg_pc == 6))</code></pre>
</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="__code_mktop_code_the_driver_testbench_in_file_code_top_bs_code">5.1.7. <code>mkTop</code>, the driver &#8220;testbench&#8221; (in file <code>Top.bs</code>)</h4>
<div class="paragraph">
<p>We import a standard BH/BSV library that implements a module
generating pseudo-random numbers (linear feedback shift register):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>import LFSR</code></pre>
</div>
</div>
<div class="paragraph">
<p>whose interface looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    Bits t n =&gt; interface LFSR t
      value :: t
      next  :: Action</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be used on any type <code>t</code> that has a <code>Bit n</code> representation.  The
<code>value</code> method yields the next random value, and the <code>next</code> method
advances it to generate the next random value.</p>
</div>
<div class="paragraph">
<p>We instantiate two registers to count-off the input and output
sequences, instantiate the random-number generator (which, here
generates values of type <code>Bit 8</code>, and instantiate the Bubblesort
module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        rg_j1 :: Reg (Int  32) &lt;- mkReg  0
        rg_j2 :: Reg (Int  32) &lt;- mkReg  0
        lfsr :: LFSR (Bit  8) &lt;- mkLFSR_8
        sorter :: Sort_IFC &lt;- mkBubblesort</code></pre>
</div>
</div>
<div class="paragraph">
<p>This rule feeds inputs.  It has an explicit condition, but also it can
only fire when <code>sorter.put</code> is enabled.  The <code>zeroExtend</code> typeclassed
function extends <code>Bit 8</code> to <code>Bit 32</code>.  The <code>unpack</code> function (in the
<code>Bits</code> typeclass) converts <code>Bit 32</code> to <code>UInt 32</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>          "rl_feed_inputs": when (rg_j1 &lt; n)
            ==&gt; do
                    let v :: Bit 32 = zeroExtend  lfsr.value
                    lfsr.next
                    let x :: Int 32 = unpack  v
                    sorter.put  x
                    rg_j1 := rg_j1 + 1
                    $display  "%0d: x_%0d = %0d"  cur_cycle  rg_j1  x</code></pre>
</div>
</div>
<div class="paragraph">
<p>This rule drains and prints outputs.  It has an explicit condition,
but also it can only fire when <code>sorter.get</code> is enabled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>          "rl_drain_outputs": when (rg_j2 &lt; n)
            ==&gt; do
                    y &lt;- sorter.get
                    rg_j2 := rg_j2 + 1
                    $display "                   %0d: y_%0d = %0d"  cur_cycle  rg_j2  y
                    if1  (rg_j2 == n-1)  $finish</code></pre>
</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_let_s_do_it_compile_link_and_simulate_the_example_3">5.1.8. Let&#8217;s do it! Compile, link and simulate the example</h4>
<div class="paragraph">
<p>Use Bluesim or Verilog sim, and generate a VCD waveform file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Eg030a_Bubblesort
$ make b_compile b_link b_sim_vcd
...
Bluesim simulation ...
./mkTop_b_sim
1: x_0 = 1
2: x_1 = 142
3: x_2 = 71
4: x_3 = 173
5: x_4 = 216
                                16: y_0 = 1
                                17: y_1 = 71
                                18: y_2 = 142
                                19: y_3 = 173
                                20: y_4 = 216
Bluesim simulation and dumping VCD in dump.vcd finished</code></pre>
</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_waveforms_code_gtkwave_dump_vcd_code">5.1.9. Waveforms (<code>$ gtkwave  dump.vcd</code>)</h4>
<div id="Bubblesort_A_Waves" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_A_Waves.png" alt="Bubblesort A Waves">
</div>
<div class="title">Figure 11. Waveforms from sequential Bubblesort</div>
</div>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="_bubblesort_version_b_with_concurrency">5.2. Bubblesort Version (b): with concurrency</h3>
<div class="paragraph">
<p>Please visit this directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ cd  Examples/Eg030b_Bubblesort</code></pre>
</div>
</div>
<div class="paragraph">
<p>and examine the source file <code>src/Bubblesort.bs</code> (the
top-level file <code>src/Top.bs</code> is identical to the previous version, we&#8217;re
only changing the internal implementation of Bubblesort).</p>
</div>
<div class="paragraph">
<p>New strategy: the module will perform swaps concurrently.  In
fact, it starts swapping as inputs are streamed in.</p>
</div>
<div id="Bubblesort_B_overview" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_B_overview.png" alt="Bubblesort B overview" width="400">
</div>
<div class="title">Figure 12. Behavior in concurrent Bubblesort</div>
</div>
<hr>
<div class="sect3">
<h4 id="_bubblesort_with_concurrency">5.2.1. Bubblesort with concurrency</h4>
<div class="paragraph">
<p>The interface to <code>mkBubblesort</code> remains unchanged.  In the module, we
now provide an initial value for our data registers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    x0 :: Reg  (Int  32) &lt;- mkReg  maxBound</code></pre>
</div>
</div>
<div class="paragraph">
<p>As in Haskell, <code>maxBound</code> is resolved using typeclasses to be the
maximum ordered value in the <code>Int 32</code> type.  We use <code>maxBound</code> as a
&#8220;sentinel&#8221; value, and assume no actual input to be sorted has that
value (we&#8217;ll fix this limitation in a later version).</p>
</div>
<div class="paragraph">
<p>This expression continually tests whether the array is full and is sorted:<sup>1</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    let done :: Bool
        done = ((rg_inj == 5) &amp;&amp; (x0 &lt;= x1) &amp;&amp; (x1 &lt;= x2) &amp;&amp; (x2 &lt;= x3) &amp;&amp; (x3 &lt;= x4))</code></pre>
</div>
</div>
<div class="paragraph">
<p>What do we mean by &#8220;continually&#8221;?  Remember that any pure value
expression in BH/BSV represents a combinational circuit, an acyclic
circuit of AND/OR/NOT gates, and is a pure function its inputs.  Here,
each <code>&lt;=</code> is a <em>comparator</em> circuit (a combinational circuit defined
in terms of AND/OR/NOT) whose inputs are connected to the bits in the
various registers or fixed at a constant value and with a single
output wire carrying the comparison result.  We AND all these together
to drive a single wire called <code>done</code>.  This wire continually carries
the value of this computation based on the current values in the
registers.  This picture shows the hardware:</p>
</div>
<div id="Bubblesort_B_done" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_B_done.png" alt="Bubblesort B done" width="400">
</div>
<div class="title">Figure 13. Hardware for <code>done</code></div>
</div>
<div class="paragraph">
<p><sup>1</sup> <em>If you are squirming at this tedious repetition: don&#8217;t worry, we&#8217;ll use a <code>fold</code> soon.</em></p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_swapping">5.2.2. Swapping</h4>
<div class="paragraph">
<p>Our swap rules are no longer sequenced by any program counter. Here are the first two rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        "rl_swap_0_1": when  (x0 &gt; x1) ==&gt; do
            x0 := x1
            x1 := x0

        "rl_swap_1_2": when  (x1 &gt; x2) ==&gt; do
            x1 := x2
            x2 := x1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each rule swaps its two registers whenever they&#8217;re mis-ordered.</p>
</div>
<div id="Bubblesort_B_swap" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_B_swap.png" alt="Bubblesort B swap" width="150">
</div>
<div class="title">Figure 14. Hardware for a <code>swap</code> rule, seen in isolation</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_swapping_and_concurrency">5.2.3. Swapping and concurrency</h4>
<div class="paragraph">
<p>This brings up a very important point: what if both rules are enabled?
I.e., what if <code>x0</code> and <code>x1</code> are in the wrong order, and <code>x1</code> and <code>x2</code>
are also in the wrong order?  Then, they&#8217;ll both try to read and write
the register they share, <code>x1</code>.  Do we have a race condition?</p>
</div>
<div class="paragraph">
<p>In BH/BSV semantics, rules are <em>atomic</em> by definition, so we don&#8217;t
have to worry about race conditions. It&#8217;s up to the implementation to
guarantee that they execute in some <em>logical</em> order (logically either
<code>rl_swap_0_1</code> before <code>rl_swap_1_2</code> or the other way around).  <code>bsc</code>
will produce hardware that guarantees this.</p>
</div>
<div class="paragraph">
<p>The figure shows additional detail for the hardware for a swapping
rule.</p>
</div>
<div id="Bubblesort_B_swap_detail" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_B_swap_detail.png" alt="Bubblesort B swap detail" width="500">
</div>
<div class="title">Figure 15. Hardware for a <code>swap</code> rule, seen more detail</div>
</div>
<div class="paragraph">
<p>First, each register input has a <em>multiplexer</em> (which is basically an
if- or case- expression) to choose one of many possible inputs
(remember that register <code>x1</code> is updated in both rules <code>rl_swap_0_1</code>
and in rule <code>rl_swap_1_2</code>).</p>
</div>
<div class="paragraph">
<p>Second, a <code>Control</code> block (also a combinational circuit) takes the
basic rule condition (<code>CAN_FIRE</code>) but also combines it with the
<code>CAN_FIRE</code> conditions of other rules to further ensure that firing
this rule will not violate atomicity (<code>WILL_FIRE</code>).  The <code>WILL_FIRE</code>
signal of a rule or method essentially drives &#8220;enable&#8221; signals
(<code>EN</code>, <code>ENA</code>) of state elements to control whether or not their state
is updated.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Though we may leave atomicity of rules to the <code>bsc</code> compiler, we
may still be curious (and in some cases worried, due to considerations
of fairness, starvation, deadlock etc.) about what logical order is
chosen by the compiler.  There are ways to control this, illustrated
in the source file later under <code>ifdef OPTION2</code>, <code>OPTION3</code> and
<code>OPTION4</code>.  Please feel free to study that code later.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_input">5.2.4. Input</h4>
<div class="paragraph">
<p>The <code>put</code> method for input now just records the new input in register
<code>x4</code>, and does not do any shifting.  Its rule condition checks that
<code>x4</code> is &#8220;empty&#8221; (contains <code>maxBound</code>); this prevents <code>put</code> from
overwriting this value by the next value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        put x = do
                    x4 := x
                    rg_inj := rg_inj + 1
                when ((rg_inj &lt; 5) &amp;&amp; (x4 == maxBound))</code></pre>
</div>
</div>
<div id="Bubblesort_B_put" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_B_put.png" alt="Bubblesort B put" width="500">
</div>
<div class="title">Figure 16. Hardware for <code>put</code> method, seen in isolation</div>
</div>
<div class="paragraph">
<p>As soon as we&#8217;ve registered the first input, <code>x3</code> and <code>x4</code> will be
mis-ordered because <code>x3</code> contains <code>maxBound</code>, so rule <code>rl_swap_3_4</code>
will be enabled to swap it</p>
</div>
<div class="paragraph">
<p>Swapping can begin immediately the first input arrives, and can
continue as more inputs arrive.</p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_output">5.2.5. Output</h4>
<div class="paragraph">
<p>The <code>get</code> method for output returns <code>x0</code> and shifts as before, except
here we shift in <code>maxBound</code> to prepare the module for its the next
use.  On the last output (when <code>x1 == maxBound</code>) we restore <code>rg_inj</code>
to 0, making the module ready for its next use (enabling <code>get</code> again).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        get = do
                x0 := x1
                x1 := x2
                x2 := x3
                x3 := x4
                x4 := maxBound
                if1 (x1 == maxBound) (rg_inj := 0)
                return x0
              when  done</code></pre>
</div>
</div>
<div id="Bubblesort_B_get" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_B_get.png" alt="Bubblesort B get" width="500">
</div>
<div class="title">Figure 17. Hardware for <code>get</code> method, seen in isolation</div>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_let_s_do_it_compile_link_and_simulate_the_example_and_look_at_waves">5.2.6. Let&#8217;s do it! Compile, link and simulate the example, and look at waves</h4>
<div class="paragraph">
<p>Use Bluesim or Verilog sim, and generate a VCD waveform file.</p>
</div>
<div class="paragraph">
<p>Observe that the text output on the terminal is exactly the same as
Version (a).  What&#8217;s different will be the internal concurrency and
timing, which is visible in the VCD file.</p>
</div>
<div id="Bubblesort_B_Waves" class="imageblock" style="text-align: center">
<div class="content">
<img src="./Figures/Bubblesort_B_Waves.png" alt="Bubblesort B Waves">
</div>
<div class="title">Figure 18. Waveforms from concurrent Bubblesort</div>
</div>
<div class="paragraph">
<p>Compare this with the waveform for the sequential version in
<a href="#Bubblesort_A_Waves">Waveforms from sequential Bubblesort</a>.  Here, the <code>WILL_FIRE</code> signals show swap rules
firing concurrently, and firing even before all inputs have arrived.
The whole computation finishes in fewer cycles (see <code>CLK</code>).</p>
</div>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="_bubblesort_versions_c_d_and_e_generalizations">5.3. Bubblesort Versions (c), (d) and (e): generalizations</h3>
<div class="paragraph">
<p>There are three more example directories in the Bubblesort group.
These are mostly an exposition of using standard Haskell-ry (types,
higher-order functions, lists) for more expressivity in the hardware
description.  They should be easy to follow by anyone who knows
Haskell.  We leave that as an exercise for the reader, but in the next
section we briefly discuss a few highlights of the final version.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Version (c)</dt>
<dd>
<p>Generalize from sorting 5 values to sorting <em>n</em> values,
using a vector of <em>n</em> registers instead of explicitly listing out
all the registers.</p>
</dd>
<dt class="hdlist1">Version (d)</dt>
<dd>
<p>Generalize from sorting values of <code>Int 32</code> to values of any type
<code>t</code> that can be represented in bits and on which we can define an
ordering.</p>
</dd>
<dt class="hdlist1">Version (e)</dt>
<dd>
<p>Use a <code>Maybe</code> type for register contents so that properly identify
&#8220;empty&#8221; registers instead encoding it using <code>maxBound</code>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
We remind the reader that all the Haskell-ry in BH/BSV is
concerned only with STRUCTURE, i.e., describing the moudule heirarchy,
rules, how they connect with methods, etc.  In other words, circuit
structure description.  The BEHAVIOR of the circuit (how its state and
signals evolve over time) is given by rule semantics, which has nothing
to do with Haskell per se.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
These examples use <em>n</em> registers to hold the values being
sorted.  This hardware is not reasonable when <em>n</em> is large (100s,
1000s, &#8230;&#8203; billions).  For that, one would store the data in an SRAM
or DRAM memory module (which has dense, optimized circuitry that can
store gigabytes, unlike separate registers).  That is the subject of
the <em>mergesort</em> example, later.
</td>
</tr>
</table>
</div>
<hr>
<div class="sect3">
<h4 id="_bubblesort_version_e_highlights">5.3.1. Bubblesort Version (e): highlights</h4>
<div class="paragraph">
<p>The interface type generalizes to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(Bubblesort_IFC :: # -&gt; * -&gt; *)  n_t  t</code></pre>
</div>
</div>
<div class="paragraph">
<p>i.e., it becomes a polymorphic type constructor where <code>n_t</code> is a
numeric type representing the size of the vector of values to be
sorted, and <code>t</code> is the type of the values to be sorted.</p>
</div>
<div class="paragraph">
<p>The module type declaration now acquires some typeclass constraints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mkBubblesort :: (Bits  t  wt,                -- ensures 't' has a hardware bit representation
                 Ord  t,                     -- ensures 't' has the '&lt;=' comparison operator
                 Eq  t)                      -- ensures 't' has the '==' comparison operator
                 =&gt;
                 Module  (Bubblesort_IFC  n_t  t)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Numeric types can be lowered to corresponding numeric values (of type <code>Integer</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    let  n    :: Integer = valueOf  n_t</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instantiating a vector of registers by repeated <code>mkReg</code> instantiation using monadic <code>replicateM</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    xs :: Vector  n_t  (Reg  (Maybe  t)) &lt;- replicateM  (mkReg  Invalid)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lambdas, lists and fold-like functions over vectors for our <code>done</code> predicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>                   (List.all (\i -&gt; ((xs !! i)._read &lt;= (xs !! (i+1))._read))
                             (List.upto  0  (n - 2)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rules as first class objects: a function to generate a swap rule:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        gen_swap_rule :: Integer -&gt; Rules
        gen_swap_rule  i = let
                               xs_i        = xs !! i
                               xs_i_plus_1 = xs !! (i+1)
                           in
                               rules
                                 "rl_swap_i": when (xs_i &gt; xs_i_plus_1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rules as first class objects: adding a generated list of rules to a module&#8217;s collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    addRules_list_descending_urgency  (List.map  gen_swap_rule  (List.upto  0  (n - 2)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>descending_urgency</code> provides additional direction to <em>bsc</em> please
to give the rules a descending priority order.</p>
</div>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="_an_aside_on_style">5.4. An Aside on Style</h3>
<div class="paragraph">
<p>Our examples often use certain stylistic conventions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>_IFC</code> at the end of interface names</p>
</li>
<li>
<p><code>mk</code> at the front of module names</p>
</li>
<li>
<p><code>rg_</code> at the front of register names</p>
</li>
<li>
<p><code>rl_</code> at the front of rule names</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Later examples will also use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mv_</code>, <code>ma_</code>, <code>mav_</code>  in front of names of value, Action and ActionValue  methods, respectively</p>
</li>
<li>
<p><code>fv_</code>, <code>fa_</code>, <code>fav_</code>  in front of names of value, Action and ActionValue  functions, respectively</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All these conventions are purely this author&#8217;s chosen style to improve
readability, and are not <em>required</em> by the syntax.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pipelining_memory_access_and_accelerators_example_mergesort">6. Pipelining, memory access and accelerators (example: &#8220;Mergesort&#8221;)</h2>
<div class="sectionbody">
<hr>
<div class="sect2">
<h3 id="_where_do_accelerators_fit_into_a_computer_system">6.1. Where do Accelerators Fit into a Computer System?</h3>
<div id="Fig_Accelerator_Models" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/Accelerator_Models.png" alt="Accelerator Models" width="700">
</div>
<div class="title">Figure 19. From tightly-coupled to loosely-coupled accelerators</div>
</div>
<div class="ulist">
<ul>
<li>
<p>How closely-coupled (&#8220;tight&#8221;) is the accelerator to the CPU pipeline?</p>
<div class="ulist">
<ul>
<li>
<p>How often is the hand-off from the &#8220;main&#8221; computation
(executed by code on the CPU) to the &#8220;accelerated&#8221;
computation and back?</p>
</li>
<li>
<p>How much work is done by the accelerator for each invocation between handoffs?</p>
</li>
</ul>
</div>
</li>
<li>
<p>How is data shared between the &#8220;main&#8221; computation to the &#8220;accelerated&#8221; computation?</p>
<div class="ulist">
<ul>
<li>
<p>Does the accelerator need to access CPU registers and/or to memory?</p>
</li>
<li>
<p>Is memory access shared with CPU caches?</p>
</li>
<li>
<p>Is such sharing cache-coherent?</p>
</li>
<li>
<p>Does the accelerator use virtual or physical addresses?</p>
</li>
<li>
<p>How is the accelerator&#8217;s access to memory made secure (only permitted accesses)?</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_our_example_a_memory_to_memory_mergesort_accelerator">6.2. Our example: a memory-to-memory &#8220;mergesort&#8221; accelerator</h3>
<div id="Fig_Accelerator_Flow" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/Accelerator_Flow.png" alt="Accelerator Flow" width="700">
</div>
<div class="title">Figure 20. CPU-accelerator protocol</div>
</div>
<div class="paragraph">
<p>All transactions are memory reads or writes, through the AXI4 system
interconnect.  System interconnects are also known as &#8220;system buses&#8221;
even though for speed reasons modern system interconnects are
typically no longer &#8220;buses&#8221; (a shared set of wires), but actually a
packet-switched network.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
AXI4 is an open interconnect standard defined by ARM (<a href="#AXISpec">[AXISpec]</a>).
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Prequel: the CPU prepares a vector in memory to be sorted.</p>
</li>
<li>
<p>The CPU &#8220;configures&#8221; the accelerator by performing a series of
&#8220;writes&#8221; to the accelerator through the system interconnect.  In
our example, this includes:</p>
<div class="ulist">
<ul>
<li>
<p>The starting address of vector A of 64-bit words (input and output).</p>
</li>
<li>
<p>The starting address of the same-sized vector B (work area).</p>
</li>
<li>
<p>The size of the vectors (number of 64-bit words).</p>
</li>
<li>
<p>A &#8220;control&#8221; write that tells the accelerator to begin sorting,</p>
</li>
</ul>
</div>
</li>
<li>
<p>The accelerator performs reads and writes to memory via the system
interconnect, and implements the sorting algorithm.</p>
</li>
<li>
<p>While the accelerator works, the CPU continually &#8220;polls`"the
accelertor for an indication of completion, by doing a "`status&#8221;
read.</p>
<div class="ulist">
<ul>
<li>
<p>Sometimes instead of polling, the accelerator may &#8220;interrupt&#8221;
the CPU to indicate completion; we will not be showing that
here.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sequel: the CPU computes with sorted vector.</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_mergesort_source_codes">6.3. Mergesort: source codes</h3>
<div class="paragraph">
<p>The BH/BSV source codes for the <em>Flute</em> CPU and the SoC
(System-on-a-chip) into which we&#8217;ll attach our accelerator should be
cloned from GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    git clone https://github.com/bluespec/Flute</code></pre>
</div>
</div>
<div class="paragraph">
<p>The source code for our Mergesort example is in two files of &lt;300 lines each:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    ICFP2020_Bluespec_Tutorial/Examples/Eg040_Mergesort/src/AXI4_Accel.bs
    ICFP2020_Bluespec_Tutorial/Examples/Eg040_Mergesort/src/Merge_Engine.bs</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Regarding Flute and WindSoC</div>
<div class="paragraph">
<p>Please feel free to peruse the Flute and WindSoC code at your leisure.
It is written in BSV, not BH, but if you squint appropriately, it has
the same underlying syntactic structure as BH.  The two major parts of
the repo are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$(FLUTE)$/src_Core/</code>: RISC-V ISA definitions, Flute CPU, caches and
MMUs, PLIC (Platform Level Interrupt Controller), <code>Near_Mem_IO</code>
(memory mapped timer, timer-interrupt and software-interrupt
generator), Debug Module (for remote GDB control over a RISC-V
executable, and Tandem-Verification trace encoder.</p>
</li>
<li>
<p><code>$(FLUTE)$/src_Testbench</code>: The SoC (including Boot ROM, memory
controller, UART and AXI4 interconnection fabrics) and a top-level
wrapper for simulation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The repo also has build directories for several variants (32-bit and
64-bit RISC-V, with and without Virtual Memory, etc.), precompiled ISA
tests, scripts to run everything, etc.</p>
</div>
</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_mergesort_algorithm">6.4. Mergesort algorithm</h3>
<div id="Mergesort_algorithm" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/Mergesort_algorithm.png" alt="Mergesort algorithm">
</div>
<div class="title">Figure 21. Mergesort algorithm</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Note that each &#8220;merge&#8221; 's input segment is already
sorted, and its output segment is also sorted.</p>
</li>
<li>
<p>Each pass reads from an input array and writes to an output array.</p>
</li>
<li>
<p>Opportunities for concurrency:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each &#8220;merge&#8221; 's memory requests cn be pipeline, i.e., the
path from the merge hardware to memory (requests) and back
(responses).  We can launch memory read-requests as fast as we
can generate them, consume read-responses as they arrive to
perform the merge, and stream the final write-requests out
from the merge.</p>
</li>
<li>
<p>Multiple instances of &#8220;merge&#8221; can be done concurrently.</p>
<div class="ulist">
<ul>
<li>
<p>The are completely independent of each other.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If we use multple arrays, multiple &#8220;passes&#8221; can be done
concurrently <strong>*</strong> Provided that a pass can &#8220;wait&#8221; for its
input data that is being produced by an earlier pass. We
could use an &#8220;IVar&#8221; (I-Structure Variable) for
this.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In our example, we&#8217;ll only use opportunity (1).</p>
<div class="ulist">
<ul>
<li>
<p>Opportunity (2) is usable if memory has sufficient bandwidth to
handle so many concurrent reads and writes.</p>
</li>
<li>
<p>Opportunity (3) will take a lot of resources (memory) for the
data.  It also has tricky synchronization, which &#8220;IVars&#8221;
(I-Structure variables) would neatly solve, but this adds
further hardware cost and complexity.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If we complete one pass before starting the next, we avoid the IVar
synchronization issue.  Further, we can alternate between two
arrays A and B for input and output.  (We may need a final copy
if we don&#8217;t end with the data in the desired output array).</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_mergesort_visualizing_the_merge_step">6.5. Mergesort: visualizing the merge step</h3>
<div id="Mergesort_merge" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/Mergesort_merge.png" alt="Mergesort merge" width="600">
</div>
<div class="title">Figure 22. Merge step: sort two already-sorted segments of length &#8220;span&#8221;</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Note that each &#8220;merge&#8221; 's input segment is already
sorted, and its output segment is also sorted.</p>
</li>
<li>
<p>In the code, we will see registers and wires with the same names as in the figure.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_merge_engine_sorts_two_input_segments_into_1_output_segment">6.6. The Merge Engine (sorts two input segments into 1 output segment)</h3>
<div class="paragraph">
<p>Please examine the file: <code>Examples/Eg040_Mergesort/src/Merge_Engine.bs</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The functions <code>fv_mkMemReadReq</code> and <code>fv_mkMemWriteReq</code> create AXI4
memory-request structs for the given address and data. The details
can be ignored here.</p>
<div class="ulist">
<ul>
<li>
<p>The <code>id</code> argument is a tag (0 or 1) that we attach on concurrent
requests for data from the left and right segments of
<code>merge_engine</code> inputs, so that we can disambiguate the responses
(since responses arrive on the same AXI4 interface).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_merge_engine_interface">6.7. The Merge Engine: interface</h3>
<div class="paragraph">
<p>Other than an <code>init</code> interface to initialize the module, the &#8220;work&#8221; methods are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>interface Merge_Engine_IFC =
   init :: Action

   start :: ... &lt;args&gt; ... -&gt; Action
   done  :: Bool

   initiator_ifc :: AXI4_Master_IFC  Wd_Id  Wd_Addr  Wd_Data  Wd_User</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Each time we want to do a &#8220;merge&#8221; step, we invoke the <code>start</code>
method giving it all the information it needs about location and
size of its two input and one output segments. Later, <code>done</code> will
become true when it has finished merging the segments.</p>
</li>
<li>
<p>While it works, it issues memory reads and writes via
<code>initiator_ifc</code>.  The numeric type paramters of <code>AXI4_Master_IFC</code>
specify standard AXI4 parameters: bit widths of address, data, id
and user fields carried in AXI4 requests and responses.</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_merge_engine_talking_to_the_axi4_interconnect_bus">6.8. The Merge Engine: Talking to the AXI4 interconnect (bus)</h3>
<div class="paragraph">
<p>The <a href="#AXISpec">[AXISpec]</a> from ARM that defines the AXI4 protocol has much
detail about wires, signalling etc.  To simplify our lives, we define
some library components called &#8220;transactors&#8221; (a.k.a. adapter, or
shim) that take care of all the signalling details and present us,
instead, with simple FIFO enqueue/dequeue interfaces for the different
AXI4 channels.  We instantiate such a component in <code>mkMerge_Engine</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    initiator_xactor :: AXI4_Master_Xactor_IFC  Wd_Id Wd_Addr Wd_Data Wd_User
        &lt;- mkAXI4_Master_Xactor;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The source for this transactor, and other related Bluespec BH/BSV
definitions of AXI4 types, interfaces, interconnects, etc. can be
found in the <em>Flute</em> repository at: <code>src_Testbench/Fabrics/AXI4/</code></p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_merge_engine_flow">6.9. The Merge Engine: Flow</h3>
<div id="Merge_Engine_Flow" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/Merge_Engine_Flow.png" alt="Merge Engine Flow">
</div>
<div class="title">Figure 23. Merge Engine Flow (in module <code>mkMerge_Engine</code> in file <code>Merge_Engine.bs</code>)</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Rules <code>rl_req0</code> and <code>rl_req1</code> each traverse one input segment (left
and right inputs of &#8220;merge&#8221;), generating and launching read
requests to memory for each word.  They tag their requests with a
<code>tid</code> (transaction id) of 0 and 1 respectively, so that we can
disambiguate responses.</p>
</li>
<li>
<p>Rules <code>rl_rsp0</code> and <code>rl_rsp1</code> collect responses and place the data
into FIFOs <code>f_data0</code> and <code>f_data1</code>, respectively.  They use <code>tid</code>
to select the FIFO target.</p>
<div class="ulist">
<ul>
<li>
<p>Note: we assume that responses come in the order they were
requested, to each input segment&#8217;s data will arrive into its
FIFO in sorted order.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Rule <code>rl_merge</code> peforms the merge, always looking at the head of
FIFOs <code>f_data0</code> and <code>f_data1</code>, and passing through the smaller and
sending it in a write-request to memory.</p>
</li>
<li>
<p>Finally, rule <code>rl_drain_write_rsps</code> collects write-responses and
discards them.</p>
<div class="ulist">
<ul>
<li>
<p>Read- and write- requests and responses all flow on different
&#8220;channels&#8221; in the AXI4 interconnect, so reads and writes do
not need disambiguation.</p>
</li>
<li>
<p>By waiting for write responses, we can ensure that we don&#8217;t
start the first &#8220;merge&#8221; of the next pass (which reads memory)
before completion of the last &#8220;merge&#8221; of the last pass (which
writes memory).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_merge_engine_avoiding_deadlock_in_the_pipeline">6.10. The Merge Engine: Avoiding Deadlock in the Pipeline</h3>
<div class="ulist">
<ul>
<li>
<p>Deadlock scenario: suppose <code>f_data0</code> has become empty and <code>f_data1</code> has
become full.  Suppose the next response from memory (FIFO &#8220;Memory
responses&#8221; in the diagram) is for <code>f_data1</code>, let&#8217;s call it X.</p>
<div class="ulist">
<ul>
<li>
<p>Then, any data meant for <code>f_data0</code>, which is &#8220;behind&#8221; X, is
stuck there behind X since we cannot move X into <code>f_data1</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Solution: This is a classic &#8220;head-of-line blocking&#8221; scenario, and
the solution is standard:</p>
<div class="ulist">
<ul>
<li>
<p>Fix a number <code>max_n_reqs_in_flight</code> that limits the number of
read requests that can be outstanding from either segment.</p>
</li>
<li>
<p>Ensure that rules <code>rl_req0</code> and <code>rl_req1</code> cannot exceed this
number of requests:</p>
<div class="ulist">
<ul>
<li>
<p>Give them that many &#8220;credits&#8221; at the beginning.</p>
</li>
<li>
<p>Decrement the credit on each request, and don&#8217;t issue any
request when credit is zero.</p>
</li>
</ul>
</div>
</li>
<li>
<p>As items are consumed from <code>f_data0</code> and <code>f_data1</code>, restore
those credits.</p>
</li>
<li>
<p>Ensure that FIFOs <code>f_data0</code> and <code>f_data</code> are have enough
capacity to hold that many responses.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Conceptually these credit counters are just registers that are
decremented and incremented to consume and resplenish credits,
respectively, and can be instantiated as usual using <code>mkRegU</code>.  In the
code (file <code>Merge_Engine.bs</code>), however, we use &#8220;Concurrent
Registers&#8221; for this, instantiated with <code>mkCRegU</code>.  This is a
performance optimization, about which more in the Section
<a href="#ConcurrentRegs">[ConcurrentRegs]</a>.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_mergesort_module_code_mkaxi4_accel_code_in_file_code_axi4_accel_bs_code">6.11. The Mergesort Module (<code>mkAXI4_Accel</code> in file <code>AXI4_Accel.bs</code>)</h3>
<div class="paragraph">
<p>On the system interconnect, our accelerator is both:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a target/server (for configuration &amp; status: receives read/write requests from CPU)</p>
</li>
<li>
<p>an initiator/client (for work: sends read/write requests to memory)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and this is visualized in this diagram:</p>
</div>
<div id="Mergesort_interfaces" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/Mergesort_interfaces.png" alt="Mergesort interfaces">
</div>
<div class="title">Figure 24. Mergesort module interfaces, and sketch of internal activity</div>
</div>
<div class="paragraph">
<p>The interface code is specified in the Flute repository at
<code>src_Testbench/SoC/AXI4_Accel_IFC</code>.  It&#8217;s in BSV (not BH) syntax:<sup>1</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>interface AXI4_Accel_IFC;
   method Action init (Bit# (Wd_Id) axi4_id, Bit #(Wd_Addr) addr_base, Bit #(Wd_Addr) addr_lim);

   interface AXI4_Slave_IFC  #(Wd_Id, Wd_Addr, Wd_Data, Wd_User)  slave;

   method Bool interrupt_req;

   interface AXI4_Master_IFC #(Wd_Id, Wd_Addr, Wd_Data, Wd_User)  master;
endinterface</code></pre>
</div>
</div>
<div class="paragraph">
<p>but we can squint at it through BH-colored glasses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>interface AXI4_Accel_IFC =
   init          :: (Bit Wd_Id)  (Bit Wd_Addr)  (Bit Wd_Addr) -&gt; Action
   slave         :: AXI4_Slave_IFC  Wd_Id  Wd_Addr  Wd_Data  Wd_User
   interrupt_req :: Bool
   master        :: AXI4_Master_IFC  Wd_Id  Wd_Addr  Wd_Data  Wd_User</code></pre>
</div>
</div>
<div class="paragraph">
<p><sup>1</sup> Apologies for the unpleasant &#8220;master/slave&#8221; terminology; it was
used widely in hardware design and ARM used it in their AXI4 spec
(<a href="#AXISpec">[AXISpec]</a>, 2013).  For new designs we suggest using &#8220;client&#8221; or
&#8220;initiator&#8221; instead of &#8220;master&#8221; and &#8220;server&#8221; or &#8220;target&#8221;
instead of &#8220;slave&#8221;.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_the_mergesort_module_code_code_mkaxi4_accel_code_in_file_code_axi4_accel_bs_code">6.12. The Mergesort Module Code (<code>mkAXI4_Accel</code> in file <code>AXI4_Accel.bs</code>)</h3>
<div class="paragraph">
<p>As in <code>Merge_Engine</code>, we instantiate an AXI4 slave transactor through
which we receive AXI4 requests and send responses, for configuration.
The configuration itself is stored in a vector of 4 registers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    target_xactor :: AXI4_Slave_Xactor_IFC  Wd_Id Wd_Addr Wd_Data Wd_User  &lt;- mkAXI4_Slave_Xactor

    v_csr :: Vector  N_CSRs  (Reg  Fabric_Addr) &lt;- replicateM  (mkReg 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rules <code>rl_handle_config_read_req</code> and <code>rl_handle_config_write_req</code>
handle AXI4 requests from the CPU for initializing the configuration
registers, receiving the &#8220;Go!&#8221; command from the CPU, and returning
completion status to the CPU.</p>
</div>
<div class="paragraph">
<p>We instantiate a merge-engine, and a register to hold the current
&#8220;span&#8221; under consideration (which starts at 1 and doubles on each
pass until it encompasses the whole sort array):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    merge_engine :: Merge_Engine_IFC &lt;- mkMerge_Engine
    rg_span :: Reg  Fabric_Addr &lt;- mkRegU</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next set of rules encode a state machine described by the following pseudo-code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L0: start when we&#8217;ve received &#8220;Go!&#8221; from the CPU</p>
</li>
<li>
<p>L1: For span = 1, 2, 4, &#8230;&#8203; until &gt;= n</p>
<div class="ulist">
<ul>
<li>
<p>L2: Initialize the pass with start-index i = 0</p>
</li>
<li>
<p>L3: While i &lt; size of array</p>
<div class="ulist">
<ul>
<li>
<p>L4: Do a merge (merge_engine.start)<br>
and increment i to the next span</p>
</li>
</ul>
</div>
</li>
<li>
<p>L5: Double the span and exchange the array roles</p>
</li>
</ul>
</div>
</li>
<li>
<p>L6: If final data is not in original array, copy it</p>
</li>
<li>
<p>L7: Wait for all merges to complete, and signal completion to CPU</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_let_s_do_it_compile_link_the_example_but_don_t_try_simulating_yet">6.13. Let&#8217;s do it! Compile, link the example (but don&#8217;t try simulating yet)</h3>
<div class="paragraph">
<p>First, in <code>Eg040_Mergesort/Makefile</code>, there is a line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>REPO ?= $(FLUTE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please define an environment variable <code>FLUTE</code> to point at your clone
of the <em>Flute</em> repo, or edit the <code>Makefile</code> line to point at it.</p>
</div>
<div class="paragraph">
<p>Then, compile and link it (but not simulate):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Eg040_Mergesort
$ make all</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will use <code>bsc</code> to compile all the code (our two local source
files, and a very large number of source files from the Flute/WindSoc
repository) and link it into a Bluesim executable.</p>
</div>
<div class="paragraph">
<p>Before we run the simulation, we need some RISC-V binaries for <em>Flute</em> to execute.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_for_simulation_risc_v_machine_code_for_flute_execution">6.14. For simulation: RISC-V machine-code for Flute execution</h3>
<div class="paragraph">
<p>We are going to execute (pre-compiled versions of) two C programs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Resources/C_programs

$ ls hello/
hello*	hello.c  hello.map  hello_Mem.hex  hello.text  Makefile  symbol_table.txt

$ ls mergesort/
mergesort*   mergesort.map	mergesort.text
mergesort.c  mergesort_Mem.hex	symbol_table.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have provided pre-compiled RISC-V binaries; this diagram
illustrates how they were created, in case you wish to recreate them
yourself (later), or repeat the flow with new or modified C programs.</p>
</div>
<div id="RISCV_SW_Flow" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RISCV_SW_Flow.png" alt="RISCV SW Flow" width="600">
</div>
<div class="title">Figure 25. Flow for creating RISC-V executables for our example</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Source files are compiled using <em>gcc</em> targeting RISC-V machine code
(instead of x86).  &#8220;RISC-V International&#8221; is the global
non-profit that steers RISC-V; you can find links to RISC-V tools
(including <em>gcc</em>) on their web site (<a href="https://riscv.org/" class="bare">https://riscv.org/</a>).</p>
<div class="ulist">
<ul>
<li>
<p>When running <em>gcc</em>, it uses some &#8220;bare metal&#8221; libraries in <code>C_programs/lib</code></p>
</li>
<li>
<p>From <code>hello.c</code>, <em>gcc</em> produces <code>hello</code> (ELF executable),
<code>hello.text</code> (RISC-V Assembly Language listing), <code>hello.map</code>
(linker map).</p>
</li>
</ul>
</div>
</li>
<li>
<p>ELF files are usually unpacked and loaded by an operating system
(but we don&#8217;t have one, since we&#8217;re using &#8220;bare metal&#8221;).</p>
<div class="ulist">
<ul>
<li>
<p>In hardware engineering it is traditional to initialize memory
contents with a &#8220;memory hex dump&#8221;.  This is just a listing in
ASCII hexadecimal text of memory contents.</p>
</li>
<li>
<p>In the tutorial repo, we provide an <code>elf_to_hex</code> program in <code>Resources/elf_to_hex</code>.</p>
</li>
<li>
<p>This produces, for example, <code>hello_Mem.hex</code> and <code>symbol_table.txt</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>(This process is also described in more detail in the README in the <code>C_programs/</code> directory.)</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_let_s_do_it_run_the_hello_world_risc_v_binary">6.15. Let&#8217;s do it! Run the &#8220;Hello, World!&#8221; RISC-V binary.</h3>
<div class="paragraph">
<p>First, please examine:  <code>Resources/C_programs/hello/hello.c</code><br>
it&#8217;s just the standard iconic &#8220;Hello World!&#8221; program.</p>
</div>
<div class="paragraph">
<p>Then, run it on the Bluesim simulation we&#8217;ve just created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Eg040_Mergesort

$ make run_hello
cp  ../Resources/C_programs/hello/hello_Mem.hex     ./Mem.hex
cp  ../Resources/C_programs/hello/symbol_table.txt  ./symbol_table.txt
./exe_HW_sim  +tohost
...
================================================================
Bluespec RISC-V WindSoC simulation v1.2
Copyright (c) 2017-2020 Bluespec, Inc. All Rights Reserved.
================================================================
...
================================================================
CPU: Bluespec  RISC-V  Flute  v3.0 (RV64)
Copyright (c) 2016-2020 Bluespec, Inc. All Rights Reserved.
================================================================
...
Hello World!
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>printf</code> in the program is linked by gcc to a library that writes
out the characters to the UART (Universal Asynchronous Receiver
Transmitter) in our SoC, and our simulation model of the UART merely
prints each character to the screen.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_c_code_to_test_the_mergesort_accelerator">6.16. C code to test the mergesort accelerator</h3>
<div class="paragraph">
<p>Please examine:  <code>Resources/C_programs/mergesort/mergesort.c</code><br>
In <code>main()</code> we have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    run (! accelerated, A, B, n);
    ...
    run (accelerated, A, B, n);</code></pre>
</div>
</div>
<div class="paragraph">
<p>i.e., we do two runs, each sorting an array of words in memory.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the first run, we use a C function <code>mergesort ()</code> that has been
compiled to RISC-V machine code, which is executed on the RISC-V CPU.</p>
</li>
<li>
<p>In the second run, we use our hardware accelerator.  The C code just
writes out the addresses and size of the arrays to the
accelerator, writes the &#8220;Go!&#8221; command, and then waits, polling,
for completion:</p>
</li>
<li>
<p>For our test, the input array is in inverse-sorted order; after
running a sort, some C code verifies that the output is in sorted
order.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    accel_0_addr_base [1] = (uint64_t)  pA;
    accel_0_addr_base [2] = (uint64_t)  pB;
    accel_0_addr_base [3] = (uint64_t)  n;
    // "Go!"
    accel_0_addr_base [0] = (uint64_t)  1;

    // Wait for completion
    while (true) {
        uint64_t status = accel_0_addr_base [0];
        if (status == 0) break;
    }</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will also see some calls to <code>fence()</code>.  This is to ensure that
data values prepared by the CPU have been flushed out of caches into
memory (so the accelerator can see them) and, after the acceleration,
to ensure that data values updated by the accelerator are reloaded by
the CPU into its caches.<sup>1</sup></p>
</div>
<div class="paragraph">
<p><sup>1</sup> This is a complex subject (&#8220;coherence&#8221; between memory seen by
the CPU and by the accelerator), for which there are many approaches,
involving hardware support and software conventions.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_let_s_do_it_run_the_code_mergesort_code_risc_v_binary">6.17. Let&#8217;s do it! Run the <code>mergesort</code> RISC-V binary.</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ pwd
 ... ICFP2020_Bluespec_Tutorial/Examples/Eg040_Mergesort

$ make run_mergesort
cp  ../Resources/C_programs/mergesort/mergesort_Mem.hex  ./Mem.hex
cp  ../Resources/C_programs/mergesort/symbol_table.txt   ./symbol_table.txt
./exe_HW_sim  +tohost
...
================================================================
Bluespec RISC-V WindSoC simulation v1.2
Copyright (c) 2017-2020 Bluespec, Inc. All Rights Reserved.
================================================================
...
================================================================
CPU: Bluespec  RISC-V  Flute  v3.0 (RV64)
Copyright (c) 2016-2020 Bluespec, Inc. All Rights Reserved.
================================================================
...
Running C function for mergesort
Verified 3000 words sorted
 Sorting took  1932331 cycles
Done
Running hardware-accelerated mergesort
...
Verified 3000 words sorted
 Sorting took   321869 cycles
Done</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that accelerated sort has about a 6X speedup over the
software sort.  This is respectable, but not huge, in part because
mergesort, even when run in software, is mostly limited by memory
system performance (it does not do much computation on the data read
from memory).  Flute does nto have a sophisticated memory system, and
the hardware accelerator has lots of room for improvment (see next
section).</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_mergesort_possible_improvements_suggested_exercise">6.18. Mergesort: Possible Improvements (suggested exercise!)</h3>
<div class="paragraph">
<p>Robustness:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Proper use of <code>fence</code> instructions in the C code</p>
</li>
<li>
<p>Support misaligned data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Functionality and generality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow &#8220;records&#8221; (<code>structs</code>) for data, of various sizes, sorting on
a key field of any type with <code>Ord</code>.</p>
</li>
<li>
<p>Allow <code>scatter/gather</code> arrays (indirection from arrays to records).</p>
</li>
<li>
<p>Allow out-of-order responses from memory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Performance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use AXI4&#8217;s &#8220;burst&#8221; reads and writes to read/write segments,
instead of individual-word reads/writes.</p>
</li>
<li>
<p>Replicate <code>mkMerge_Engine</code> to do multiple merges in each step
concurrently (if memory has the bandwidth to support it)</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clocks_concurrency_semantics_performance_and_concurrent_registers">7. Clocks, Concurrency Semantics, Performance, and Concurrent Registers</h2>
<div class="sectionbody">
<div id="ConcurrentRegs" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This section is a bit heavy, and can safely be skipped on
    first reading.  But it is an important topic describing aspects of
    BH/BSV that are essential for performance tuning.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Although we have been generating clocked hardware in all our
examples, we have hardly mentioned clocks at all in our
discussion, and in fact our source codes have no mention of clocks
(<em>bsc</em> managed all the details for us).  This is the norm when
working with BH/BSV: we mostly think in terms of rule steps
(all actions of a rule, performed atomically).</p>
</li>
<li>
<p>The <em>bsc</em> compiler translates BH/BSV into clocked digital hardware
(expressed in Verilog).  Every rule is mapped into hardware that
executes in a single clock<sup>1</sup>, and <em>bsc</em> tries to have as many
rules firing in a clock as possible, for maximum performance.</p>
</li>
<li>
<p>In this section:</p>
<div class="ulist">
<ul>
<li>
<p>We provide some insight into how <em>bsc</em> allows multiple rules to
fire in a clock while preserving atomicity</p>
</li>
<li>
<p>We describe another primitive (Concurrent Registers, or CRegs)
that permit higher degrees of concurrency (multiple rules in a
clock) than ordinary registers (CRegs were used for the
&#8220;credit counters&#8221; in the Merge Engine in our Mergesort
example).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><sup>1</sup> There is nothing in BH/BSV rule semantics that demands that a rule
  must fire within one clock; it&#8217;s a choice by the
  compiler. Alternative compilation strategies can change that; the
  only sacrosanct property is that a rule&#8217;s actions must appear to be
  atomic with respect to all other rules.</p>
</div>
<hr>
<div class="sect2">
<h3 id="_concurrency_and_parallelism_in_em_bsc_em_generated_hardware_for_rules">7.1. Concurrency and Parallelism in <em>bsc</em>-generated Hardware for Rules</h3>
<div class="paragraph">
<p>Rule semantics are explained in two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Individual rule: logically, a rule fires in a single instant.  All
the actions in the rule (and in any methods it invokes) happen at
the same instant.  We call this <em>parallelism of actions</em>.</p>
</li>
<li>
<p>Multiple rules within a clock: logically, they execute in sequence,
so the overall state change in a clock can be understood as the
simple sequential composition of the state changes of the individual
rules.  We call this the <em>concurrency of rules</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is visualized in the following picture:</p>
</div>
<div id="ConcurrencyParallelism" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/ConcurrencyParallelism.png" alt="ConcurrencyParallelism">
</div>
<div class="title">Figure 26. Concurrency and Parallelism in <em>bsc</em>-generated Hardware for Rules</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_parallelism_simultaneity_of_actions_in_a_rule">7.2. Parallelism (Simultaneity) of Actions in a Rule</h3>
<div class="paragraph">
<p>Suppose we had a rule like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>when ((y /= 0) &amp;&amp; got_x &amp;&amp; got_y) ==&gt; do
   if1 (lsb(y) == 1) w := w + x
   x := x &lt;&lt; 1
   y := y &gt;&gt; 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are three actions in the rule. All are governed by the rule
condition, but one of them (assignment to <code>w</code>) is further governed by
the predicate of the <code>if</code>.  The hardware corresponding to this can be
visualized as in this picture:</p>
</div>
<div id="RuleActions_HW_Intuition" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RuleActions_HW_Intuition.png" alt="RuleActions HW Intuition">
</div>
<div class="title">Figure 27. Parallel (Simultaneous) Actions in a Rule</div>
</div>
<div class="paragraph">
<p>It consists of combinational circuits (pure functions, acyclic graphs
built from primitive gates) originating at value methods of certain
primitives (here, register reads), and feeding data inputs and
&#8220;enable&#8221; inputs (EN/ENA/ENABLE) of state elements (here, registers).
These EN and data inputs of primitives correspond to their Action.</p>
</div>
<div class="paragraph">
<p>When a state element&#8217;s EN is asserted at a clock edge, it captures
(or, consumes) the value on its data input, at the instant of the
clock edge.  Since all the state elements are driven by the same
clock, these actions all happen at the same instant.</p>
</div>
<div class="paragraph">
<p>In the picture, if the rule condition (<code>CAN_FIRE</code>) is false, none of
the actions will be performed. If true, the <code>x</code> and <code>y</code> writes will
occur. If the <code>if</code> condition is also true, the <code>w</code> write will occur.</p>
</div>
<div class="literalblock">
<div class="title">Semantics of an individual rule:</div>
<div class="content">
<pre>    (Simultaneously)
    For each of the rule’s actions whose enabling condition is True,
        do the action</pre>
</div>
</div>
<div class="paragraph">
<p>Summary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is no ordering among the actions of a rule; they all happen at the same instant.</p>
</li>
<li>
<p>Not all actions may be performed (due to internal conditions in the rule).</p>
</li>
<li>
<p>Any values &#8220;read&#8221; by the rule are from &#8220;before&#8221; the instant of execution.</p>
</li>
<li>
<p>any values affected by the rule are visible only `after`" the instant.</p>
</li>
</ul>
</div>
<div id="RuleActions" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RuleActions.png" alt="RuleActions" width="300">
</div>
<div class="title">Figure 28. Parallel (Simultaneous) Actions in a Rule</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_concurrency_of_rules_within_a_clock">7.3. Concurrency of Rules Within a Clock</h3>
<div class="paragraph">
<p>Define a schedule as some linear ordering of all rules in a program: r1, r2, &#8230;&#8203;, rN</p>
</div>
<div class="paragraph">
<p>(For now, consider <em>any</em> order; defer the question of how to pick an order.)</p>
</div>
<div id="RuleConcurrency1" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RuleConcurrency1.png" alt="RuleConcurrency1">
</div>
<div class="title">Figure 29. Concurrency of Rules Within a Clock</div>
</div>
<div class="literalblock">
<div class="title">Semantics of rules within each clock:</div>
<div class="content">
<pre>    Consider each rule in schedule order:
        If its rule-condition is true,
           and it does not conflict with rules already executed in this clock
        Then execute this rule</pre>
</div>
</div>
<div class="paragraph">
<p>We will explain &#8220;conflict&#8221; in a moment.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_method_ordering_constraints_inducing_conflicts">7.4. Method-ordering Constraints (Inducing &#8220;Conflicts&#8221;)</h3>
<div class="paragraph">
<p>Consider two rules in schedule order that may invoke methods <code>mA</code> and
<code>mB</code> of a common module <code>x</code>.  These method invocations may be in the
rule&#8217;s condition or in its body.</p>
</div>
<div id="RuleOrdering1" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RuleOrdering1.png" alt="RuleOrdering1" width="300">
</div>
</div>
<div class="paragraph">
<p>For every module <code>x</code>, each pair of its methods has one of the following ordering constraint:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Method order constraints</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>Constraint</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Meaning</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">mA conflict-free mB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rules invoking mA and mB can fire in same clock, in either order</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">mA &lt; mB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rule invoking mA can fire before rule invoking mB</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">mA &gt; mB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rule invoking mB can fire before rule invoking mA</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">mA confict mB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rules invoking mA and mB <em>cannot</em> fire in same clock (neither order)</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>For primitive modules, these constraints are built-in (&#8220;given&#8221;, &#8220;axiomatic&#8221;).</p>
</li>
<li>
<p>For user-defined modules, these are inferred from the module implementation (by the compiler).</p>
</li>
</ul>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_example_of_method_ordering_constraints_on_primitive_registers">7.5. Example of Method-ordering Constraints on Primitive Registers</h3>
<div class="paragraph">
<p>For standard primitive registers (which we get using <code>mkReg</code> and
<code>mkRegU</code>) the given method-ordering constraint is: <code>_read &lt; _write</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>One can see how this models a real hardware register: during a
clock, we can only read the old value (from the last clock edge)
and when we write, it is only visible after the next clock edge.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These constraints may result in a <em>conflict</em> for some rule schedules:</p>
</div>
<div id="RegisterMethodOrdering" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RegisterMethodOrdering.png" alt="RegisterMethodOrdering">
</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_from_method_ordering_to_rule_conflicts">7.6. From Method Ordering to Rule Conflicts</h3>
<div class="paragraph">
<p>We say that there is a conflict between an ordered pair of rules r1
and r2 + if there is an ordering conflict between <em>any</em> pair of
methods x.m1 invoked in r1 and x.m2 invoked in r2 (on the same module
instance x).</p>
</div>
<div id="RuleOrdering2" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RuleOrdering2.png" alt="RuleOrdering2" width="400">
</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_for_conflicts_the_earlier_rule_disables_the_later_rule">7.7. For Conflicts, the Earlier Rule Disables the Later Rule</h3>
<div class="paragraph">
<p>Suppose the compiler has chosen the following schedule</p>
</div>
<div id="RuleConcurrency2" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/RuleConcurrency2.png" alt="RuleConcurrency2" width="300">
</div>
<div class="title">Figure 30. Schedule of Rules Within a Clock</div>
</div>
<div class="paragraph">
<p>and suppose there is a conflict between r3 and r5, i.e., they each
invoke methods on some common module instance x where the
method-ordering contraints are not consistent with the schedule order.</p>
</div>
<div class="paragraph">
<p>The compiler produces hardware that disables rule r5 whenever r3
fires, i.e., logic that looks like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>        WILL_FIRE_r5 = (! WILL_FIRE_r3) &amp;&amp; CAN_FIRE_r5</pre>
</div>
</div>
<div class="paragraph">
<p><code>CAN_FIRE_r5</code> is r5&#8217;s condition seen in isolation: its rule-condition and its method-conditions.</p>
</div>
<div class="paragraph">
<p><code>WILL_FIRE_r5</code> indicates whether the rule will actually fire on this clock.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_summary_of_rule_semantics">7.8. Summary of Rule Semantics</h3>
<div class="ulist">
<ul>
<li>
<p>When compiled, a BH/BSV program has a statically determined
<em>schedule</em> of rules (a linear ordering).</p>
</li>
<li>
<p>On every clock, conceptually rules are considered in schedule order.</p>
</li>
<li>
<p>A rule <code>WILL_FIRE</code> if its own condition (<code>CAN_FIRE</code>) is true
(rule-condition + method conditions) and if firing the rule would
not violate a method-ordering conflict with any rule already
executed in this clock.</p>
</li>
<li>
<p>When a rule fires, all its actions are performed at the same instant.</p>
</li>
<li>
<p>The overall state-change in a clock is the sequential composition of
the state changes due to individual rules fired in the clock in
schedule order.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This only explains the strategy used by our particular compiler
    (<em>bsc</em>) to achieve the high-level goal that rules must fire
    atomically.  Other strategies for executing BH/BSV are possible,
    including strategies that don&#8217;t involve clocks (asynchronous
    logic), etc.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The semantics works for <em>any</em> schedule (linear ordering).  The
  <em>bsc</em> compiler implements some sophisticated analyses to produce a
  &#8220;good&#8221; order, with &#8220;goodness&#8221; measured by more concurrency.
  Other objectives, such as energy-efficiency may result in different
  choices.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_concurrent_registers_cregs_motivation">7.9. Concurrent Registers (CRegs): Motivation</h3>
<div class="paragraph">
<p>From the previous discussion, it should be clear that if two rules rA
and rB invoke the <code>_read</code> and <code>_write</code> methods of a standard register,
respectively, then they can fire concurrently only if rA is earlier in
the schedule than rB.</p>
</div>
<div class="paragraph">
<p>But consider the &#8220;credit&#8221; counter we saw in the Merge Engine of our
Mergesort example.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a memory request is launched, we decrement the credit counter (use credit).</p>
</li>
<li>
<p>When a memory response is consumed, we increment the credit counter (replenish credit).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both rules read and write the register, and so these two rules can
never fire concurrently (either ordering will have a <code>_write</code> before a
<code>_read</code>).  The rules can only fire on different clocks.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_concurrent_registers_cregs">7.10. Concurrent Registers (CRegs)</h3>
<div class="paragraph">
<p>A CReg is another register-like primitive.  It provides, as its
interface, an <em>array_</em> of <code>Reg</code> interfaces (let us call each a
&#8220;port&#8221;), with the following ordering constraints:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. CReg method ordering constraints</caption>
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 41.6666%;">
<col style="width: 8.3333%;">
<col style="width: 41.6668%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports [0]._read</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports [0]._write</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports[1]._read</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports[1]._write</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports[2]._read</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports[2]._write</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports[n-1]._read</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ports[n-1]._write</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>At each index j, read and write are ordered like an ordinary register.
But what is interesting and different from a standard register is that
the read on a later port can be scheduled <em>after</em> a write on an
earlier port.  That means that value written in one port is available
and communicated to reads on higher ports.</p>
</div>
<div class="paragraph">
<p>Returning to our credit counter problem, we can schedule the
incrementing and decrementing rules concurrently by using different
ports of a CReg (the choice of ports will determine which rule goes
first).  This is indeed the case in the example code in module
<code>mkMerge_Engine</code> in file <code>Merge_Engine.bs</code>.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_concurrent_registers_cregs_hardware_implemntation">7.11. Concurrent Registers (CRegs): Hardware Implemntation</h3>
<div class="paragraph">
<p>Here is a hardware implementation of the CReg primitive.</p>
</div>
<div id="CReg_HW" class="imageblock" style="text-align: center">
<div class="content">
<img src="Figures/CReg_HW.png" alt="CReg HW" width="500">
</div>
<div class="title">Figure 31. CReg Hardware Implementation</div>
</div>
<div class="paragraph">
<p>It contains a standard register with a series of muxes (multiplexers).
At index 0, the read-value is the standard register value.  At index
1, the read-value is muxed from the index-0 write (if it occurs) and
the previous read-value, and so on.</p>
</div>
<div class="paragraph">
<p>The neat property about a CReg is that, when thinking at the abstract
level of rules (no clocks, just rule-steps), they are equivalent to
standard registers (just ignore the port indexes).  Thus, they are an
excellent formal bridge betwen the two levels of abstraction: rules by
themselves, and rules-mapped-to-clocks.</p>
</div>
<div class="paragraph">
<p>In general, the process of designing a system can be separated cleanly
into two phases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Do the design just thinking in terms of rules, and using standard
registers, and establish correctness of the design.</p>
</li>
<li>
<p>Selectively and judiciously replace standard registers with CRegs
to tune up performance to required performance goals.</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_word_about_multiple_clocks_and_resets_and_clock_domains_and_reset_domains">8. A Word About Multiple Clocks (and Resets) and Clock Domains (and Reset Domains)</h2>
<div class="sectionbody">
<div id="Clocks" class="paragraph">
<p>Many non-trivial hardware systems involve multiple clocks: certain
parts of the circuit may run at higher clock speeds and other parts at
slower clock speeds.  The motivations may include balancing energy
consumption (higher clock speeds burn more energy), adhering to
externally mandated clocking standards (e.g., for standard interfaces
like USB or PCIe), etc.</p>
</div>
<div class="paragraph">
<p>Usually a system has a clean &#8220;partitioning&#8221; into discrete &#8220;clock
domains&#8221; each clocked by a single clock.  This partitioning is
orthogonal to the module hierarchy, i.e., clock domains may cut across
a module hierarchy; a module may contain sections on different clocks.</p>
</div>
<div class="paragraph">
<p>So called &#8220;clock-domain discipline&#8221; ensures that communication from
one clock-domain to another is only done through certain carefully
engineered domain-crossing primitives called &#8220;synchronizers&#8221;.</p>
</div>
<div class="paragraph">
<p>In BH/BSV, Clocks and Reset are first-class types, and can be made
explicitly visible as interfaces and values, and &#8220;plumbed&#8221; through
the module hierarchy using usual function an module composition
mechanisms.  Further, clock-domain discipline undergoes strong static
checking guaranteeing that domain-crossings always go through
synchronizers.</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_quality_metrics_for_hardware">9. Quality metrics for hardware</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The quality of a hardware system is measured in several ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Silicon level:</p>
<div class="ulist">
<ul>
<li>
<p>Area (gates, mm^2, LUTs, RAMs, DSPs, &#8230;&#8203;)</p>
</li>
<li>
<p>Clock speed (MHz)</p>
</li>
<li>
<p>Energy and Energy Efficiency (Joules, Watts)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Micro-architecture level:</p>
<div class="ulist">
<ul>
<li>
<p>Latency: how long does it take to process a datum?</p>
</li>
<li>
<p>Throughput: how many data per time (due to concurrency: pipelining, replication, &#8230;&#8203;)?</p>
</li>
</ul>
</div>
</li>
<li>
<p>Application level</p>
<div class="ulist">
<ul>
<li>
<p>Wall-clock time</p>
</li>
</ul>
</div>
</li>
<li>
<p>Accelerators</p>
<div class="ulist">
<ul>
<li>
<p>Speedup</p>
</li>
<li>
<p>Overhead of hand-offs from main CPU to accelerator and back (cf. Amdahl&#8217;s Law)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="sect2">
<h3 id="_formal_verification">9.1. Formal Verification</h3>
<div class="ulist">
<ul>
<li>
<p>Historically, in the HW design community, &#8220;Verification&#8221; has meant &#8220;Testing&#8221;</p>
<div class="ulist">
<ul>
<li>
<p>Although, in the ASIC world, testing has historically been
<em>much</em> more rigorous than in the SW world, given that the cost
of an error can be in the millions of dollars.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Formal verification tools for SystemVerilog have recently become
available, and now being used for small-subystem verification.</p>
</li>
<li>
<p>BH/BSV&#8217;s strong (Haskell-ish) type-checking itself provides a
certain degree of formal verification not previously available in
HDLs.</p>
</li>
<li>
<p>BH/BSV&#8217;s composable <em>Guarded Atomic Actions</em> opens the door for an
even stronger role for formal verication.</p>
<div class="ulist">
<ul>
<li>
<p>Atomic transactions are the most powerful construct available for reasoning about concurrent behaviors</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_endnote_comparison_with_other_approaches_to_hardware_design">10. Endnote: Comparison with other approaches to hardware-design</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Section <a href="#HDLS_vs_HLS">HLHDLs vs. HLS: precise specification of micro-architecture</a> we have already compared HDLs against HLS (see <a href="#GajskiHLS">[GajskiHLS]</a>)
(synthesis of hardware from and algorithm specified in C/C++).</p>
</div>
<div class="paragraph">
<p>Both Chisel (see <a href="#Chisel">[Chisel]</a>) and BSV significantly raise the level of
abstraction and expressive power of HDLs compared to Verilog (see
<a href="#IEEEVerilog2005a">[IEEEVerilog2005a]</a>), SystemVerilog (see <a href="#IEEESystemVerilog2012a">[IEEESystemVerilog2012a]</a>)
and VHDL (see <a href="#IEEEVHDL2002">[IEEEVHDL2002]</a>).  Chisel achieves this by being an
embedded DSL inside Scala, and is thus able to use Scala&#8217;s expressive
power to express abstractions and composition.</p>
</div>
<div class="paragraph">
<p>There have been a few attempts at using Haskell directly for hardware design:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&#8220;Lava&#8221; (see <a href="#Lava">[Lava]</a>) is an embedded DSL in Haskell, using Haskell
to express powerful and high-level combinators for structural
composition of clocked digital circuits.</p>
</li>
<li>
<p>Clash (see <a href="https://clash-lang.org/" class="bare">https://clash-lang.org/</a>) borrows notation and types
from Haskell, but is not an embedded DSL; it has its own compiler.
The Haskell-ish notation is used directly to express computational
circuits, with <code>Signal</code> datatype arguments/results indicating
sequential (stateful) circuits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all the above approaches, clocked digital logic is front and
center; it is the central model of behavior, and they are all directly
describing clocked digital circuits.  To our knowledge, BH/BSV is
unique in having atomic rules as its central behavioral model,
adjoined with a methodology of how these are mapped to clocked digital
circuits.</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_bibliography">11. Bibliography</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a id="AXISpec"></a>[AXISpec]
<em>AMBA AXI and ACE Protocol Specification: AXI3 , AXI4 , and AXI4-Lite; ACE and ACE-Lite</em>,
Document IHI 0022E (ID022613), ARM, 2013</p>
</div>
<div class="paragraph">
<p><a id="Chisel"></a>[Chisel]
<em>Chisel: constructing hardware in a Scala embedded language</em>
Jonathan Bachrach <em>et. al.</em>,
in <em>Proceedings of the 49th Annual Design Automation Conference (DAC 2012).
San Francisco, CA, USA</em>,
June 2012,
pp. 1216–1225.</p>
</div>
<div class="paragraph">
<p><a id="RefGuide"></a>[RefGuide]
<em>Bluespec SystemVerilog Reference Guide</em>,  Bluespec, Inc.,
July 21, 2017, 421pp.</p>
</div>
<div class="paragraph">
<p><a id="UserGuide"></a>[UserGuide]
<em>Bluespec SystemVerilog and Bluespec Development
Workstations User Guide</em>, Bluespec, Inc., July 21, 2017, 118pp.</p>
</div>
<div class="paragraph">
<p><a id="GajskiHLS"></a>[GajskiHLS]
<em>High-level synthesis: introduction to chip and system design</em>,
D.D. Gajski,
Kluwer Academic, Boston, 1992</p>
</div>
<div class="paragraph">
<p><a id="IEEEVerilog2005a"></a>[IEEEVerilog2005a]
<em>IEEE Standard Verilog &#174; Hardware Description Language</em>, IEEE,
IEEE Std 1364-2005, 2005.</p>
</div>
<div class="paragraph">
<p><a id="IEEESystemVerilog2012a"></a>[IEEESystemVerilog2012a]
<em>IEEE Standard for System Verilog---Unified Hardware Design, Specification and Verification Language</em>,
IEEE, IEEE Std 1800-2012, February 21, 2013.</p>
</div>
<div class="paragraph">
<p><a id="IEEEVHDL2002"></a>[IEEEVHDL2002]
<em>IEEE Standard VHDL Language Reference Manual, IEEE Std 1076-1993</em>,
IEEE, 2002</p>
</div>
<div class="paragraph">
<p><a id="IEEESystemC2011a"></a>[IEEESystemC2011a]
<em>IEEE Standard for Standard SystemC Language Reference Manual</em>,
IEEE, IEEE Std 1666-2011, January 9, 2012.</p>
</div>
<div class="paragraph">
<p><a id="Kernighan78"></a>[Kernighan78]
<em>The C Programming Language</em>,
Brian W. Kernighan and Dennis M. Ritchie,
Prentice Hall,
1978</p>
</div>
<div class="paragraph">
<p><a id="BluespecCACM"></a>[BluespecCACM]
<em>Abstraction in Hardware System Design</em>,
Rishiyur S. Nikhil,
in <em>Communications of the ACM</em>, 54:10, October 2011, pp. 36-44</p>
</div>
<div class="paragraph">
<p><a id="BSV_by_Example"></a>[BSV_by_Example] <em>BSV by Example</em>, Rishiyur S. Nikhil and Kathy R. Czeck,
December 2010, 302pp., ISBN-10: 1456418467; ISBN-13: 978-1456418465; available on
<a href="http://www.amazon.com/BSV-Example-Rishiyur-S-Nikhil/dp/1456418467/ref=sr_1_2?ie=UTF8&amp;s=books&amp;qid=1294863695&amp;sr=8-2">Amazon</a>.</p>
</div>
<div class="paragraph">
<p><a id="Haskell98Report"></a>[Haskell98Report]
<em>Haskell 98 Language and Libraries: The Revised Report</em>,
Simon L. Peyton Jones (Editor),
Cambridge University Press,
May 5, 2003, pp._272., haskell.org</p>
</div>
<div class="paragraph">
<p><a id="Lava"></a>[Lava]
<em>Lava: Hardware Design in Haskell</em>,
Per Bjesse, Koen Claessen and Mary Sheeran and Satnam Singh,
in _Proc. ACM Intl. Conf. on Functional Programming (ICFP),
1998</p>
</div>
<hr>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version v0.1<br>
Last updated 2020-08-23 10:15:25 EDT
</div>
</div>
</body>
</html>